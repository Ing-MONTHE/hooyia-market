{% extends 'base.html' %}
{% load static %}

{% block title %}Messages â€” HooYia Market{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

  <!-- â”€â”€ En-tÃªte â”€â”€ -->
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="font-display text-2xl text-ink">Messages</h1>
      <p class="text-ink/40 font-body text-sm mt-0.5">Vos conversations avec les vendeurs</p>
    </div>
    <span id="conversations-count" class="hidden px-3 py-1 bg-cream-warm border border-cream-border rounded-full text-xs font-mono text-ink/50"></span>
  </div>

  <!-- â”€â”€ Skeleton loader â”€â”€ -->
  <div id="skeleton" class="space-y-3">
    {% for i in "123" %}
    <div class="card p-4 animate-pulse flex items-center gap-4">
      <div class="w-11 h-11 bg-cream-warm rounded-xl flex-shrink-0"></div>
      <div class="flex-1 space-y-2">
        <div class="h-3.5 bg-cream-warm rounded w-1/3"></div>
        <div class="h-3 bg-cream-warm rounded w-2/3"></div>
      </div>
      <div class="h-3 bg-cream-warm rounded w-12"></div>
    </div>
    {% endfor %}
  </div>

  <!-- â”€â”€ Ã‰tat vide â”€â”€ -->
  <div id="empty" class="hidden text-center py-20">
    <div class="w-16 h-16 bg-cream-warm rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl">ðŸ’¬</div>
    <p class="font-display text-lg text-ink mb-1">Aucun message</p>
    <p class="text-ink/40 font-body text-sm">Vos conversations avec les vendeurs apparaÃ®tront ici.</p>
    <a href="{% url 'products:liste' %}" class="btn-primary inline-block mt-6 px-6 py-2.5 text-sm">
      Parcourir le catalogue
    </a>
  </div>

  <!-- â”€â”€ Liste des conversations â”€â”€ -->
  <ul id="conversations-list" class="hidden space-y-2"></ul>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const skeleton = document.getElementById('skeleton');
  const empty    = document.getElementById('empty');
  const list     = document.getElementById('conversations-list');
  const countEl  = document.getElementById('conversations-count');

  try {
    const data = await API.get('/api/chat/', { silentError: true });
    const conversations = data.results || data;

    skeleton.classList.add('hidden');

    if (!conversations.length) {
      empty.classList.remove('hidden');
      return;
    }

    countEl.textContent = `${conversations.length} conversation${conversations.length > 1 ? 's' : ''}`;
    countEl.classList.remove('hidden');
    list.classList.remove('hidden');

    list.innerHTML = conversations.map(conv => {
      const autre      = conv.interlocuteur || {};
      const initiale   = (autre.username || '?')[0].toUpperCase();
      const nonLus     = conv.messages_non_lus || 0;
      const dernier    = conv.dernier_message;
      const apercu     = dernier ? dernier.contenu : 'DÃ©marrez la conversationâ€¦';
      const heure      = dernier ? formatHeure(dernier.date_envoi) : '';

      return `
      <li>
        <a href="/chat/${conv.id}/"
           class="card flex items-center gap-4 p-4 hover:shadow-card-hover transition-all duration-200 no-underline group">

          <!-- Avatar -->
          <div class="relative flex-shrink-0">
            <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-brand-400 to-brand-600 flex items-center justify-center text-white font-display font-bold text-base">
              ${initiale}
            </div>
            ${nonLus > 0 ? `<span class="absolute -top-1 -right-1 min-w-[18px] h-[18px] bg-red-500 text-white text-[10px] font-mono font-semibold rounded-full flex items-center justify-center px-1">${nonLus}</span>` : ''}
          </div>

          <!-- Contenu -->
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between gap-2">
              <span class="font-body font-semibold text-ink text-sm truncate group-hover:text-brand-600 transition-colors">
                ${escapeHtml(autre.username || 'Utilisateur')}
              </span>
              <span class="text-ink/30 font-mono text-xs flex-shrink-0">${heure}</span>
            </div>
            <p class="text-ink/50 font-body text-xs mt-0.5 truncate ${nonLus > 0 ? 'font-semibold text-ink/70' : ''}">
              ${escapeHtml(apercu)}
            </p>
          </div>

          <!-- Chevron -->
          <span class="text-ink/20 group-hover:text-brand-500 transition-colors flex-shrink-0">â€º</span>
        </a>
      </li>`;
    }).join('');

  } catch(e) {
    skeleton.classList.add('hidden');
    if (e && e.status === 401) {
      window.location.href = '/compte/connexion/?next=/chat/';
    } else {
      list.innerHTML = `<li class="text-center py-10 text-ink/40 font-body text-sm">Une erreur est survenue. Veuillez rÃ©essayer.</li>`;
      list.classList.remove('hidden');
    }
  }
});

function formatHeure(isoStr) {
  if (!isoStr) return '';
  const d    = new Date(isoStr);
  const now  = new Date();
  const diff = now - d;

  if (diff < 60000)      return 'Ã€ l\'instant';
  if (diff < 3600000)    return `${Math.floor(diff / 60000)} min`;
  if (diff < 86400000)   return d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  if (diff < 604800000)  return d.toLocaleDateString('fr-FR', { weekday: 'short' });
  return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
}

function escapeHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}
</script>
{% endblock %}