{% extends 'base.html' %}
{% load static %}

{% block title %}Catalogue — HooYia Market{% endblock %}

{% block content %}
<div style="max-width:1400px;margin:0 auto;padding:2rem 1.5rem;">

  <!-- Page header -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.75rem;flex-wrap:wrap;gap:1rem;">
    <div>
      <h1 style="font-family:'Sora',sans-serif;font-size:1.75rem;font-weight:800;color:var(--text-primary);margin-bottom:.25rem;">Catalogue</h1>
      <p style="font-size:.875rem;color:var(--text-muted);" id="result-count">Chargement…</p>
    </div>
    {% if user.is_staff %}
    <a href="/administration/#ajouter-produit" class="btn btn-primary" style="gap:.5rem;">
      <svg width="15" height="15" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
      Ajouter un produit
    </a>
    {% endif %}
  </div>

  <!-- Mobile filter bar -->
  <div style="display:flex;gap:.5rem;margin-bottom:1.25rem;overflow-x:auto;padding-bottom:.25rem;" class="scrollbar-hide lg:hidden">
    <button onclick="toggleMobileFilters()" class="btn btn-secondary btn-sm" style="flex-shrink:0;gap:.375rem;">
      <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
      Filtres
    </button>
    <select id="filter-ordering-mobile" class="field btn-sm" style="width:auto;flex-shrink:0;cursor:pointer;"
      onchange="Catalogue.setFilter('ordering',this.value)">
      <option value="-date_creation">Plus récents</option>
      <option value="prix">Prix ↑</option>
      <option value="-prix">Prix ↓</option>
      <option value="-note_moyenne">Mieux notés</option>
    </select>
  </div>

  <!-- Mobile filter overlay (backdrop) -->
  <div id="mobile-filter-overlay" onclick="toggleMobileFilters()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:299;backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);"></div>

  <div style="display:flex;gap:1.75rem;">

    <!-- ── SIDEBAR FILTRES ── -->
    <aside id="filter-sidebar" style="display:none;width:240px;flex-shrink:0;">
      <div class="card-raised" style="padding:1.25rem;position:sticky;top:80px;background:var(--bg-card,#fff);">

        <!-- Close button (mobile only) -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;" class="lg:hidden">
          <span style="font-weight:700;font-size:1rem;color:var(--text-primary);">Filtres</span>
          <button onclick="toggleMobileFilters()" style="width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-muted);">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="filter-section">
          <label class="label">Recherche</label>
          <div style="position:relative;">
            <input type="search" id="filter-search" placeholder="Nom du produit…" class="field" style="padding-left:2.25rem;font-size:.8rem;" />
            <svg style="position:absolute;left:.7rem;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--text-muted);" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          </div>
        </div>

        <!-- Categories -->
        <div class="filter-section">
          <label class="label">Catégorie</label>
          <div style="display:flex;flex-direction:column;gap:2px;" id="categories-list">
            <button onclick="Catalogue.setFilter('categorie', '')" data-cat=""
              class="cat-btn active">
              Toutes les catégories
            </button>
          </div>
        </div>

        <!-- Price -->
        <div class="filter-section">
          <label class="label">Prix max (FCFA)</label>
          <input type="range" id="filter-prix" min="0" max="2000000" step="10000" value="2000000"
            oninput="Catalogue.updatePrix(this.value)" />
          <div style="display:flex;justify-content:space-between;font-size:.75rem;color:var(--text-muted);margin-top:.375rem;">
            <span>0</span>
            <span id="prix-label" style="color:var(--brand-500);font-weight:600;">2 000 000</span>
          </div>
        </div>

        <!-- Sort -->
        <div class="filter-section">
          <label class="label">Trier par</label>
          <select id="filter-ordering" class="field" style="font-size:.8rem;cursor:pointer;">
            <option value="-date_creation">Plus récents</option>
            <option value="prix">Prix croissant</option>
            <option value="-prix">Prix décroissant</option>
            <option value="-note_moyenne">Mieux notés</option>
          </select>
        </div>

        <!-- Promo only -->
        <div style="display:flex;align-items:center;gap:.75rem;padding-bottom:1.25rem;margin-bottom:1.25rem;border-bottom:1px solid var(--border);">
          <input type="checkbox" id="filter-promo" style="width:16px;height:16px;" />
          <label for="filter-promo" style="font-size:.8125rem;color:var(--text-secondary);cursor:pointer;font-weight:500;">Promotions uniquement</label>
        </div>

        <button onclick="Catalogue.reset()" class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;font-size:.8rem;">
          Réinitialiser les filtres
        </button>
      </div>
    </aside>

    <!-- ── GRID ── -->
    <div style="flex:1;min-width:0;">
      <!-- Skeleton -->
      <div id="skeleton-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;">
        {% for i in "123456" %}
        <div class="card" style="padding:1rem;">
          <div class="skeleton" style="aspect-ratio:1;border-radius:.75rem;margin-bottom:.875rem;"></div>
          <div class="skeleton" style="height:.625rem;border-radius:.375rem;width:70%;margin-bottom:.5rem;"></div>
          <div class="skeleton" style="height:.625rem;border-radius:.375rem;width:45%;margin-bottom:.75rem;"></div>
          <div class="skeleton" style="height:1.25rem;border-radius:.375rem;width:35%;"></div>
        </div>
        {% endfor %}
      </div>

      <!-- Products grid (filled by JS) -->
      <div id="products-grid" style="display:none;grid-template-columns:repeat(3,1fr);gap:1rem;" data-display="grid"></div>

      <!-- Empty state -->
      <div id="empty-state" style="display:none;" class="empty-state">
        <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <p class="empty-state-title">Aucun produit trouvé</p>
        <p class="empty-state-desc">Essayez d'autres filtres ou catégories.</p>
        <button onclick="Catalogue.reset()" class="btn btn-primary btn-sm">Réinitialiser les filtres</button>
      </div>

      <!-- Pagination -->
      <div id="pagination" style="display:none;justify-content:center;gap:.5rem;margin-top:2.5rem;flex-wrap:wrap;"></div>
    </div>
  </div>
</div>

<style>
@media (min-width: 768px) {
  #skeleton-grid, #products-grid { grid-template-columns: repeat(3, 1fr) !important; }
}
@media (min-width: 1024px) {
  #filter-sidebar { display: block !important; position: static !important; width: 240px !important; height: auto !important; top: auto !important; left: auto !important; box-shadow: none !important; }
  #filter-sidebar .card-raised { position: sticky; top: 80px; }
  #skeleton-grid, #products-grid { grid-template-columns: repeat(4, 1fr) !important; }
}
@media (min-width: 1280px) {
  #skeleton-grid, #products-grid { grid-template-columns: repeat(5, 1fr) !important; }
}

/* Mobile drawer */
@media (max-width: 1023px) {
  #filter-sidebar {
    position: fixed !important;
    top: 0 !important;
    left: -320px !important;
    width: 300px !important;
    height: 100dvh !important;
    overflow-y: auto !important;
    z-index: 300 !important;
    transition: left .28s cubic-bezier(.4,0,.2,1) !important;
    padding: 0 !important;
  }
  #filter-sidebar .card-raised {
    min-height: 100%;
    border-radius: 0 !important;
    padding: 1.5rem 1.25rem 2rem !important;
    background: var(--bg-card, #fff) !important;
    box-shadow: 4px 0 24px rgba(0,0,0,.12) !important;
  }
  #filter-sidebar.mobile-open {
    left: 0 !important;
    display: block !important;
  }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/products.js' %}"></script>
<script>
function toggleMobileFilters() {
  const sb = document.getElementById('filter-sidebar');
  const overlay = document.getElementById('mobile-filter-overlay');
  const isVisible = sb.classList.contains('mobile-open');
  if (isVisible) {
    sb.classList.remove('mobile-open');
    if (overlay) overlay.style.display = 'none';
    document.body.style.overflow = '';
  } else {
    sb.classList.add('mobile-open');
    if (overlay) overlay.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }
}
</script>
{% endblock %}