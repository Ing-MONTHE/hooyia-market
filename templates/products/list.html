{% extends 'base.html' %}
{% load static %}

{% block title %}Catalogue — HooYia Market{% endblock %}

{% block content %}
<div style="max-width:1400px;margin:0 auto;padding:2rem 1.5rem;">

  <!-- Page header -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.75rem;flex-wrap:wrap;gap:1rem;">
    <div>
      <h1 style="font-family:'Sora',sans-serif;font-size:1.75rem;font-weight:800;color:var(--text-primary);margin-bottom:.25rem;">Catalogue</h1>
      <p style="font-size:.875rem;color:var(--text-muted);" id="result-count">Chargement…</p>
    </div>
    {% if user.is_staff %}
    <a href="/administration/#ajouter-produit" class="btn btn-primary" style="gap:.5rem;">
      <svg width="15" height="15" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
      Ajouter un produit
    </a>
    {% endif %}
  </div>

  <!-- Mobile filter bar -->
  <div style="display:flex;gap:.5rem;margin-bottom:1.25rem;overflow-x:auto;padding-bottom:.25rem;" class="scrollbar-hide lg:hidden">
    <button onclick="toggleMobileFilters()" class="btn btn-secondary btn-sm" style="flex-shrink:0;gap:.375rem;">
      <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
      Filtres
    </button>
    <select id="filter-ordering-mobile" class="field btn-sm" style="width:auto;flex-shrink:0;cursor:pointer;"
      onchange="Catalogue.setFilter('ordering',this.value)">
      <option value="-date_creation">Plus récents</option>
      <option value="prix">Prix ↑</option>
      <option value="-prix">Prix ↓</option>
      <option value="-note_moyenne">Mieux notés</option>
    </select>
  </div>

  <div style="display:flex;gap:1.75rem;">

    <!-- ── SIDEBAR FILTRES ── -->
    <aside id="filter-sidebar" style="display:none;width:240px;flex-shrink:0;">
      <!-- Fermer overlay en cliquant dehors (mobile) -->
      <div onclick="closeMobileFilters(event)" style="position:absolute;inset:0;z-index:-1;" class="lg:hidden"></div>
      <div id="filter-sidebar-inner" class="card-raised" style="padding:1.25rem;position:sticky;top:80px;">
        <!-- Bouton fermer (mobile) -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;" class="filter-mobile-header">
          <span style="font-size:.9375rem;font-weight:700;color:var(--text-primary);font-family:'Sora',sans-serif;">Filtres</span>
          <button onclick="closeMobileFilters()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px;display:flex;align-items:center;justify-content:center;border-radius:6px;" onmouseover="this.style.background='var(--surface-2)'" onmouseout="this.style.background='none'">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <!-- Search -->
        <div class="filter-section">
          <label class="label">Recherche</label>
          <div style="position:relative;">
            <input type="search" id="filter-search" placeholder="Nom du produit…" class="field" style="padding-left:2.25rem;font-size:.8rem;" />
            <svg style="position:absolute;left:.7rem;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--text-muted);" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          </div>
        </div>

        <!-- Categories -->
        <div class="filter-section">
          <label class="label">Catégorie</label>
          <div style="display:flex;flex-direction:column;gap:2px;" id="categories-list">
            <button onclick="Catalogue.setFilter('categorie', '')" data-cat=""
              class="cat-btn active">
              Toutes les catégories
            </button>
          </div>
        </div>

        <!-- Price -->
        <div class="filter-section">
          <label class="label">Prix max (FCFA)</label>
          <input type="range" id="filter-prix" min="0" max="2000000" step="10000" value="2000000"
            oninput="Catalogue.updatePrix(this.value)" />
          <div style="display:flex;justify-content:space-between;font-size:.75rem;color:var(--text-muted);margin-top:.375rem;">
            <span>0</span>
            <span id="prix-label" style="color:var(--brand-500);font-weight:600;">2 000 000</span>
          </div>
        </div>

        <!-- Sort -->
        <div class="filter-section">
          <label class="label">Trier par</label>
          <select id="filter-ordering" class="field" style="font-size:.8rem;cursor:pointer;">
            <option value="-date_creation">Plus récents</option>
            <option value="prix">Prix croissant</option>
            <option value="-prix">Prix décroissant</option>
            <option value="-note_moyenne">Mieux notés</option>
          </select>
        </div>

        <!-- Promo only -->
        <div style="display:flex;align-items:center;gap:.75rem;padding-bottom:1.25rem;margin-bottom:1.25rem;border-bottom:1px solid var(--border);">
          <input type="checkbox" id="filter-promo" style="width:16px;height:16px;" />
          <label for="filter-promo" style="font-size:.8125rem;color:var(--text-secondary);cursor:pointer;font-weight:500;">Promotions uniquement</label>
        </div>

        <button onclick="Catalogue.reset()" class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;font-size:.8rem;">
          Réinitialiser les filtres
        </button>
      </div><!-- /filter-sidebar-inner -->
    </aside>

    <!-- ── GRID ── -->
    <div style="flex:1;min-width:0;">
      <!-- Skeleton -->
      <div id="skeleton-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;">
        {% for i in "123456" %}
        <div class="card" style="padding:1rem;">
          <div class="skeleton" style="aspect-ratio:1;border-radius:.75rem;margin-bottom:.875rem;"></div>
          <div class="skeleton" style="height:.625rem;border-radius:.375rem;width:70%;margin-bottom:.5rem;"></div>
          <div class="skeleton" style="height:.625rem;border-radius:.375rem;width:45%;margin-bottom:.75rem;"></div>
          <div class="skeleton" style="height:1.25rem;border-radius:.375rem;width:35%;"></div>
        </div>
        {% endfor %}
      </div>

      <!-- Products grid (filled by JS) -->
      <div id="products-grid" style="display:none;grid-template-columns:repeat(3,1fr);gap:1rem;" data-display="grid"></div>

      <!-- Empty state -->
      <div id="empty-state" style="display:none;" class="empty-state">
        <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <p class="empty-state-title">Aucun produit trouvé</p>
        <p class="empty-state-desc">Essayez d'autres filtres ou catégories.</p>
        <button onclick="Catalogue.reset()" class="btn btn-primary btn-sm">Réinitialiser les filtres</button>
      </div>

      <!-- Pagination -->
      <div id="pagination" style="display:none;flex;justify-content:center;gap:.5rem;margin-top:2.5rem;flex-wrap:wrap;"></div>
    </div>
  </div>
</div>

<style>
/* Grille produits */
@media (min-width: 480px) {
  #skeleton-grid, #products-grid { grid-template-columns: repeat(2, 1fr) !important; }
}
@media (min-width: 768px) {
  #skeleton-grid, #products-grid { grid-template-columns: repeat(3, 1fr) !important; }
}
@media (min-width: 1024px) {
  #filter-sidebar { display: block !important; width: 240px !important; position: relative !important; }
  #skeleton-grid, #products-grid { grid-template-columns: repeat(4, 1fr) !important; }
}
@media (min-width: 1280px) {
  #skeleton-grid, #products-grid { grid-template-columns: repeat(5, 1fr) !important; }
}

/* Sidebar mobile : overlay plein écran */
@media (max-width: 1023px) {
  #filter-sidebar {
    display: none;
    position: fixed !important;
    inset: 0 !important;
    width: 100% !important;
    z-index: 200 !important;
    background: rgba(0,0,0,.45) !important;
    padding: 0 !important;
    overflow-y: auto !important;
  }
  #filter-sidebar.open {
    display: flex !important;
    align-items: flex-end !important;
  }
  #filter-sidebar-inner {
    background: var(--surface) !important;
    border-radius: 1.25rem 1.25rem 0 0 !important;
    padding: 1.5rem !important;
    width: 100% !important;
    max-height: 85vh !important;
    overflow-y: auto !important;
    position: relative !important;
  }
  /* Masque le sticky desktop dans la card */
  #filter-sidebar .card-raised {
    box-shadow: none !important;
    border: none !important;
    border-radius: 0 !important;
    padding: 0 !important;
    background: transparent !important;
  }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/products.js' %}"></script>
<script>
function toggleMobileFilters() {
  const sb = document.getElementById('filter-sidebar');
  const isDesktop = window.innerWidth >= 1024;
  if (isDesktop) {
    sb.style.display = sb.style.display === 'none' ? 'block' : 'none';
  } else {
    sb.classList.toggle('open');
    document.body.style.overflow = sb.classList.contains('open') ? 'hidden' : '';
  }
}

function closeMobileFilters(e) {
  if (e && e.target !== e.currentTarget) return;
  const sb = document.getElementById('filter-sidebar');
  sb.classList.remove('open');
  document.body.style.overflow = '';
}
</script>
{% endblock %}