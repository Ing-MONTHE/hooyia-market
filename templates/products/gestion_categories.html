{% extends 'base.html' %}
{% load static %}

{% block title %}Gestion des Cat√©gories ‚Äî HooYia Market{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --navy:     #0D1F5C;
  --blue:     #1E3A8A;
  --orange:   #F97316;
  --orange-d: #ea6000;
  --green:    #10b981;
  --red:      #ef4444;
  --bg:       #f0f3fa;
  --border:   #e2e8f8;
  --shadow:   0 1px 6px rgba(13,31,92,.08);
  --shadow-md:0 4px 20px rgba(13,31,92,.12);
}
*, *::before, *::after { box-sizing: border-box; }
body { background: var(--bg) !important; font-family: 'DM Sans', sans-serif; }
.page-root { display: flex; min-height: calc(100vh - 64px); }
.sidebar { width: 230px; flex-shrink: 0; background: linear-gradient(180deg, #0a1840 0%, #0D1F5C 100%); position: sticky; top: 0; height: 100vh; display: flex; flex-direction: column; overflow-y: auto; border-right: 1px solid rgba(255,255,255,.06); }
.sb-head { padding: 22px 18px 16px; border-bottom: 1px solid rgba(255,255,255,.08); }
.sb-logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 17px; color: var(--orange); }
.sb-sub  { font-size: 10.5px; color: rgba(255,255,255,.3); margin-top: 2px; }
.sb-lbl  { font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: rgba(255,255,255,.22); padding: 14px 18px 4px; }
.sb-item { display: flex; align-items: center; gap: 9px; padding: 9px 18px; font-size: 12.5px; font-weight: 500; color: rgba(255,255,255,.5); text-decoration: none; border-left: 3px solid transparent; transition: all .12s; }
.sb-item:hover { color: rgba(255,255,255,.9); background: rgba(255,255,255,.05); border-left-color: rgba(255,255,255,.15); }
.sb-item.active { color: white; background: rgba(249,115,22,.15); border-left-color: var(--orange); font-weight: 600; }
.sb-bottom { margin-top: auto; padding: 16px 18px; border-top: 1px solid rgba(255,255,255,.07); }
.sb-version { font-size: 10px; color: rgba(255,255,255,.2); }
.main-content { flex: 1; padding: 32px 40px; overflow-x: auto; }
.page-back { font-size: 11.5px; color: rgba(13,31,92,.4); text-decoration: none; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 8px; transition: color .12s; }
.page-back:hover { color: var(--orange); }
.page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 28px; }
.page-title { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; color: var(--navy); letter-spacing: -.4px; }
.page-subtitle { font-size: 13px; color: rgba(13,31,92,.45); margin-top: 3px; }
.grid-2 { display: grid; grid-template-columns: 1fr 1.5fr; gap: 24px; align-items: start; }
.card { background: white; border-radius: 14px; border: 1px solid var(--border); box-shadow: var(--shadow); }
.card-head { padding: 16px 22px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
.card-head-icon { width: 36px; height: 36px; border-radius: 9px; background: linear-gradient(135deg, var(--orange), var(--orange-d)); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; box-shadow: 0 2px 8px rgba(249,115,22,.25); }
.card-head-title { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; color: var(--navy); }
.card-head-sub { font-size: 11.5px; color: rgba(13,31,92,.4); }
.card-body { padding: 22px; }
.field-group { margin-bottom: 16px; }
.field-group:last-child { margin-bottom: 0; }
.field-label { display: block; font-size: 11px; font-weight: 700; color: var(--navy); margin-bottom: 6px; text-transform: uppercase; letter-spacing: .8px; }
.field-label span { font-weight: 400; color: rgba(13,31,92,.35); text-transform: none; letter-spacing: 0; margin-left: 4px; }
.field-input { width: 100%; padding: 10px 13px; border-radius: 9px; border: 1.5px solid var(--border); font-size: 13.5px; color: #111; font-family: 'DM Sans', sans-serif; background: #fafbff; transition: border .15s, box-shadow .15s; }
.field-input:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(30,58,138,.1); background: white; }
.field-input:hover:not(:focus) { border-color: #c4cee8; }
.field-textarea { resize: vertical; min-height: 80px; line-height: 1.5; }
.field-select { appearance: none; cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%230D1F5C' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 13px center; padding-right: 38px; }
.toggle-row { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 9px; background: #fafbff; border: 1.5px solid var(--border); }
.toggle { position: relative; display: inline-block; width: 46px; height: 25px; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; inset: 0; border-radius: 25px; background: #d1d5e8; cursor: pointer; transition: .2s; }
.toggle-slider:before { content: ''; position: absolute; width: 19px; height: 19px; border-radius: 50%; background: white; left: 3px; top: 3px; transition: .2s; box-shadow: 0 1px 4px rgba(0,0,0,.2); }
.toggle input:checked + .toggle-slider { background: var(--green); }
.toggle input:checked + .toggle-slider:before { transform: translateX(21px); }
.toggle-info { flex: 1; }
.toggle-title { font-size: 13px; font-weight: 600; color: var(--navy); }
.toggle-desc { font-size: 11.5px; color: rgba(13,31,92,.4); margin-top: 1px; }
.btn-primary { padding: 11px 24px; border-radius: 9px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif; background: linear-gradient(135deg, var(--orange), var(--orange-d)); color: white; box-shadow: 0 2px 10px rgba(249,115,22,.3); transition: all .15s; display: inline-flex; align-items: center; gap: 7px; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 5px 18px rgba(249,115,22,.4); }
.btn-secondary { padding: 11px 20px; border-radius: 9px; cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif; background: white; color: var(--navy); border: 1.5px solid var(--border); transition: all .15s; display: inline-flex; align-items: center; gap: 7px; text-decoration: none; }
.btn-secondary:hover { border-color: var(--blue); background: #f4f6fd; }
.btn-cancel { padding: 11px 20px; border-radius: 9px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif; background: #f0f3fa; color: #666; transition: all .15s; display: inline-flex; align-items: center; gap: 7px; text-decoration: none; }
.btn-cancel:hover { background: var(--border); }
.btn-row { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
.flash { padding: 12px 18px; border-radius: 9px; font-size: 13px; font-weight: 500; margin-bottom: 20px; display: flex; align-items: center; gap: 9px; animation: slideIn .2s ease; }
.flash-success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
.flash-error   { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
@keyframes slideIn { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: none; } }
.edit-banner { background: linear-gradient(135deg, rgba(30,58,138,.07), rgba(249,115,22,.05)); border: 1.5px solid rgba(30,58,138,.18); border-radius: 10px; padding: 12px 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 13px; }
.edit-banner strong { color: var(--navy); }

/* Image upload */
.drop-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 24px 16px; text-align: center; cursor: pointer; transition: all .2s; background: #fafbff; }
.drop-zone:hover, .drop-zone.drag-over { border-color: var(--blue); background: #f0f4ff; }
.img-preview { width: 60px; height: 60px; border-radius: 9px; object-fit: cover; border: 1px solid var(--border); }
.img-placeholder { width: 60px; height: 60px; border-radius: 9px; background: var(--border); display: flex; align-items: center; justify-content: center; font-size: 20px; }

/* Table */
.cat-table { width: 100%; border-collapse: collapse; }
.cat-table th { text-align: left; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: rgba(13,31,92,.35); padding: 11px 14px; border-bottom: 2px solid var(--border); }
.cat-table td { padding: 12px 14px; border-bottom: 1px solid #f0f3fa; font-size: 13px; vertical-align: middle; }
.cat-table tr:last-child td { border-bottom: none; }
.cat-table tr:hover td { background: #f9fafff0; }
.cat-row-sub td { background: #fafbff !important; }
.cat-row-sub:hover td { background: #f3f5fd !important; }
.cat-nom { font-weight: 600; color: var(--navy); }
.cat-slug { font-size: 10.5px; font-family: monospace; color: rgba(13,31,92,.35); margin-top: 2px; }
.badge { display: inline-flex; align-items: center; gap: 4px; font-size: 10.5px; font-weight: 600; padding: 3px 10px; border-radius: 20px; }
.badge-parent { background: #eff4ff; color: var(--blue); }
.badge-sous   { background: #f0fdf4; color: #16a34a; }
.badge-active { background: #d1fae5; color: #065f46; }
.badge-inactive { background: #fee2e2; color: #991b1b; }
.badge-active::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: #10b981; }
.badge-inactive::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: #ef4444; }
.action-btn { padding: 5px 11px; border-radius: 7px; font-size: 11.5px; font-weight: 600; cursor: pointer; border: 1.5px solid; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; transition: all .12s; }
.action-edit { color: var(--blue); border-color: #bfdbfe; background: #eff6ff; }
.action-edit:hover { background: #dbeafe; border-color: var(--blue); }
.action-del { color: var(--red); border-color: #fecaca; background: #fff5f5; }
.action-del:hover { background: #fee2e2; border-color: var(--red); }
.empty-state { text-align: center; padding: 50px 20px; color: rgba(13,31,92,.3); }
.empty-state .icon { font-size: 44px; margin-bottom: 12px; }
.empty-state p { font-size: 13.5px; }
.stats-row { display: flex; gap: 12px; margin-bottom: 24px; }
.stat-card { flex: 1; background: white; border: 1px solid var(--border); border-radius: 12px; padding: 14px 18px; box-shadow: var(--shadow); }
.stat-val { font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800; color: var(--navy); }
.stat-lbl { font-size: 11.5px; color: rgba(13,31,92,.4); margin-top: 2px; }
/* ‚îÄ‚îÄ VIEW TOGGLE ‚îÄ‚îÄ */
.view-toggle { display: flex; background: #f0f3fa; border-radius: 8px; padding: 3px; gap: 2px; }
.view-btn { width: 32px; height: 28px; border: none; background: transparent; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: rgba(13,31,92,.35); transition: all .15s; }
.view-btn.active { background: white; color: var(--navy); box-shadow: 0 1px 4px rgba(13,31,92,.12); }
.view-btn:hover:not(.active) { color: var(--navy); background: rgba(255,255,255,.6); }
/* Grid view */
.cat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; padding: 18px; }
.cat-card { border: 1.5px solid var(--border); border-radius: 12px; overflow: hidden; transition: all .18s; background: white; }
.cat-card:hover { box-shadow: var(--shadow-md); border-color: #c4cee8; transform: translateY(-1px); }
.cat-card.hidden-filter { display: none; }
.cat-card-img { width: 100%; aspect-ratio: 1; object-fit: cover; background: #f0f3fa; display: flex; align-items: center; justify-content: center; font-size: 28px; }
.cat-card-img img { width: 100%; height: 100%; object-fit: cover; }
.cat-card-body { padding: 12px 14px; }
.cat-card-name { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; color: var(--navy); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cat-card-slug { font-size: 10.5px; font-family: monospace; color: rgba(13,31,92,.35); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cat-card-footer { padding: 10px 14px; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 6px; }
.cat-card-actions { display: flex; gap: 5px; }
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(2px); }
.modal-overlay.hidden { display: none; }
.modal-box { background: white; border-radius: 16px; padding: 30px; max-width: 420px; width: 100%; box-shadow: 0 24px 72px rgba(0,0,0,.25); animation: modalIn .2s ease; }
@keyframes modalIn { from { opacity: 0; transform: scale(.96) translateY(8px); } to { opacity: 1; transform: none; } }
.modal-icon { font-size: 36px; margin-bottom: 12px; }
.modal-title { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; color: var(--navy); margin-bottom: 8px; }
.modal-body { font-size: 13px; color: #64748b; margin-bottom: 22px; line-height: 1.6; }
.search-wrap { position: relative; margin-bottom: 0; }
.search-input { width: 100%; padding: 9px 12px 9px 36px; border-radius: 8px; border: 1.5px solid var(--border); font-size: 13px; font-family: 'DM Sans', sans-serif; background: #fafbff; }
.search-input:focus { outline: none; border-color: var(--blue); }
.search-icon { position: absolute; left: 11px; top: 50%; transform: translateY(-50%); color: rgba(13,31,92,.3); font-size: 14px; pointer-events: none; }
@media (max-width: 900px) { .sidebar { display: none; } .main-content { padding: 20px 16px; } .grid-2 { grid-template-columns: 1fr; } .stats-row { flex-wrap: wrap; } }
</style>
{% endblock %}

{% block content %}
<div class="page-root">

  <aside class="sidebar">
    <div class="sb-head">
      <div class="sb-logo">‚öô Admin</div>
      <div class="sb-sub">HooYia Market</div>
    </div>
    <div class="sb-lbl">Navigation</div>
    <a href="{% url 'products:admin_dashboard' %}" class="sb-item">üìä Dashboard</a>
    <div class="sb-lbl">Catalogue</div>
    <a href="{% url 'products:gestion_categories' %}" class="sb-item active">üóÇ Cat√©gories</a>
    <a href="{% url 'products:liste' %}" class="sb-item">üì¶ Produits</a>
    <a href="{% url 'products:ajouter' %}" class="sb-item">‚ûï Ajouter produit</a>
    <div class="sb-lbl">Site</div>
    <a href="{% url 'products:accueil' %}" class="sb-item">üè† Voir le site</a>
    <div class="sb-bottom"><div class="sb-version">HooYia Market v1.0</div></div>
  </aside>

  <div class="main-content">
    <a href="{% url 'products:admin_dashboard' %}" class="page-back">‚Üê Retour au Dashboard</a>
    <div class="page-header">
      <div>
        <div class="page-title">üóÇ Gestion des cat√©gories</div>
        <div class="page-subtitle">Cr√©ez et organisez les cat√©gories de votre catalogue</div>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-val">{{ toutes_categories.count }}</div>
        <div class="stat-lbl">Cat√©gories actives</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="nb-racines">‚Äî</div>
        <div class="stat-lbl">Cat√©gories principales</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="nb-sous">‚Äî</div>
        <div class="stat-lbl">Sous-cat√©gories</div>
      </div>
    </div>

    {% for message in messages %}
    <div class="flash {% if message.tags == 'success' %}flash-success{% else %}flash-error{% endif %}">
      {% if message.tags == 'success' %}‚úì{% else %}‚úï{% endif %} {{ message }}
    </div>
    {% endfor %}

    <div class="grid-2">

      <!-- ‚ïê‚ïê FORMULAIRE ‚ïê‚ïê -->
      <div class="card" id="form-card">
        <div class="card-head">
          <div class="card-head-icon">{% if categorie_edit %}‚úèÔ∏è{% else %}‚ûï{% endif %}</div>
          <div>
            <div class="card-head-title">{% if categorie_edit %}Modifier la cat√©gorie{% else %}Nouvelle cat√©gorie{% endif %}</div>
            <div class="card-head-sub">{% if categorie_edit %}Mise √† jour des informations{% else %}Remplissez les champs ci-dessous{% endif %}</div>
          </div>
        </div>
        <div class="card-body">
          {% if categorie_edit %}
          <div class="edit-banner">
            ‚úèÔ∏è Vous modifiez : <strong>{{ categorie_edit.nom }}</strong>
          </div>
          {% endif %}

          <form method="POST" enctype="multipart/form-data" id="cat-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="{% if categorie_edit %}modifier{% else %}creer{% endif %}">
            {% if categorie_edit %}
            <input type="hidden" name="categorie_id" value="{{ categorie_edit.id }}">
            {% endif %}

            <div class="field-group">
              <label class="field-label" for="id_nom">Nom <span>(obligatoire)</span></label>
              <input type="text" name="nom" id="id_nom"
                value="{% if categorie_edit %}{{ categorie_edit.nom }}{% endif %}"
                placeholder="Ex: Smartphones, Ordinateurs portables‚Ä¶"
                class="field-input" required autocomplete="off" />
            </div>

            <div class="field-group">
              <label class="field-label" for="id_description">Description <span>(optionnel)</span></label>
              <textarea name="description" id="id_description" rows="3"
                placeholder="Courte description de la cat√©gorie‚Ä¶"
                class="field-input field-textarea">{% if categorie_edit %}{{ categorie_edit.description }}{% endif %}</textarea>
            </div>

            <div class="field-group">
              <label class="field-label" for="id_parent">Cat√©gorie parente <span>(laisser vide si cat√©gorie principale)</span></label>
              <select name="parent" id="id_parent" class="field-input field-select">
                <option value="">‚Äî Aucun parent (cat√©gorie racine) ‚Äî</option>
                {% for cat in toutes_categories %}
                  {% if not categorie_edit or cat.id != categorie_edit.id %}
                  <option value="{{ cat.id }}"
                    {% if categorie_edit and categorie_edit.parent_id == cat.id %}selected{% endif %}>
                    {% if cat.parent %}‚Ü≥ {% endif %}{{ cat.nom }}
                  </option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>

            <div class="field-group">
              <label class="field-label">Image <span>(optionnel)</span></label>
              {% if categorie_edit and categorie_edit.image %}
              <div style="margin-bottom:10px;display:flex;align-items:center;gap:12px;">
                <img src="{{ categorie_edit.image.url }}" alt="" class="img-preview">
                <span style="font-size:12px;color:rgba(13,31,92,.4);">Image actuelle ‚Äî d√©poser une nouvelle pour remplacer</span>
              </div>
              {% endif %}
              <div class="drop-zone" id="drop-zone-cat"
                onclick="document.getElementById('id_image').click()"
                ondragover="event.preventDefault(); this.classList.add('drag-over')"
                ondragleave="this.classList.remove('drag-over')"
                ondrop="handleDropCat(event)">
                <div id="img-preview-new-wrap">
                  <div style="font-size:28px;margin-bottom:8px;">üì∑</div>
                  <div style="font-size:13px;color:rgba(13,31,92,.5);"><strong style="color:var(--orange);">Cliquez</strong> ou glissez votre image ici</div>
                  <div style="font-size:11.5px;color:rgba(13,31,92,.3);margin-top:4px;">JPG, PNG, WebP ‚Äî recommand√© 400√ó400px</div>
                </div>
                <img id="img-preview-new" style="display:none;width:80px;height:80px;border-radius:9px;object-fit:cover;" />
              </div>
              <input type="file" name="image" id="id_image" accept="image/*" onchange="previewImage(this)" style="display:none;" />
            </div>

            <div class="field-group">
              <label class="field-label">Statut</label>
              <div class="toggle-row">
                <label class="toggle">
                  <input type="checkbox" name="est_active"
                    {% if not categorie_edit or categorie_edit.est_active %}checked{% endif %}>
                  <span class="toggle-slider"></span>
                </label>
                <div class="toggle-info">
                  <div class="toggle-title">Cat√©gorie active</div>
                  <div class="toggle-desc">Visible sur le site</div>
                </div>
              </div>
            </div>

            <div class="btn-row">
              <button type="submit" class="btn-primary">
                {% if categorie_edit %}‚úì Enregistrer les modifications{% else %}‚ûï Cr√©er la cat√©gorie{% endif %}
              </button>
              {% if categorie_edit %}
              <a href="{% url 'products:gestion_categories' %}" class="btn-cancel">‚úï Annuler</a>
              {% else %}
              <button type="reset" class="btn-cancel" onclick="resetForm()">‚Ü∫ R√©initialiser</button>
              {% endif %}
            </div>
          </form>
        </div>
      </div>

      <!-- ‚ïê‚ïê LISTE ‚ïê‚ïê -->
      <div class="card">
        <div class="card-head">
          <div class="card-head-icon">üìã</div>
          <div style="flex:1;">
            <div class="card-head-title">Cat√©gories existantes</div>
            <div class="card-head-sub">Cliquez sur Modifier pour √©diter une cat√©gorie</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="search-wrap" style="width:160px;">
              <span class="search-icon">üîç</span>
              <input type="text" id="cat-search" class="search-input" placeholder="Rechercher‚Ä¶" oninput="filterCats(this.value)" />
            </div>
            <!-- Toggle vue -->
            <div class="view-toggle">
              <button class="view-btn active" id="btn-table" onclick="setView('table')" title="Vue tableau">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 6h18M3 14h18M3 18h18"/></svg>
              </button>
              <button class="view-btn" id="btn-grid" onclick="setView('grid')" title="Vue grille">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
              </button>
            </div>
          </div>
        </div>
        <div id="cat-list-body" style="padding:0;">
          {% if toutes_categories %}

          <!-- VUE TABLEAU -->
          <div id="view-table">
          <table class="cat-table" id="cat-table">
            <thead>
              <tr>
                <th>Image</th>
                <th>Nom / Slug</th>
                <th>Type</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="cat-tbody">
              {% for cat in categories_racines %}
              <tr data-nom="{{ cat.nom|lower }}">
                <td>
                  {% if cat.image %}<img src="{{ cat.image.url }}" alt="" class="img-preview">
                  {% else %}<div class="img-placeholder">üóÇ</div>{% endif %}
                </td>
                <td>
                  <div class="cat-nom">{{ cat.nom }}</div>
                  <div class="cat-slug">/{{ cat.slug }}</div>
                </td>
                <td><span class="badge badge-parent">üè∑ Principale</span></td>
                <td>{% if cat.est_active %}<span class="badge badge-active">Active</span>{% else %}<span class="badge badge-inactive">Inactive</span>{% endif %}</td>
                <td style="display:flex;gap:6px;align-items:center;">
                  <a href="?modifier={{ cat.id }}" class="action-btn action-edit">‚úèÔ∏è Modifier</a>
                  <button onclick="confirmSupprimerCat('{% url 'products:supprimer_categorie' cat.id %}', '{{ cat.nom }}')" class="action-btn action-del">üóë</button>
                </td>
              </tr>
              {% for sous in cat.sous_categories.all %}
              <tr class="cat-row-sub" data-nom="{{ sous.nom|lower }}">
                <td>
                  {% if sous.image %}<img src="{{ sous.image.url }}" alt="" class="img-preview">
                  {% else %}<div class="img-placeholder" style="font-size:16px;">üìÅ</div>{% endif %}
                </td>
                <td>
                  <div class="cat-nom" style="padding-left:16px;">‚Ü≥ {{ sous.nom }}</div>
                  <div class="cat-slug" style="padding-left:16px;">/{{ sous.slug }}</div>
                </td>
                <td><span class="badge badge-sous">üìÇ Sous-cat.</span></td>
                <td>{% if sous.est_active %}<span class="badge badge-active">Active</span>{% else %}<span class="badge badge-inactive">Inactive</span>{% endif %}</td>
                <td style="display:flex;gap:6px;align-items:center;">
                  <a href="?modifier={{ sous.id }}" class="action-btn action-edit">‚úèÔ∏è Modifier</a>
                  <button onclick="confirmSupprimerCat('{% url 'products:supprimer_categorie' sous.id %}', '{{ sous.nom }}')" class="action-btn action-del">üóë</button>
                </td>
              </tr>
              {% endfor %}
              {% endfor %}
            </tbody>
          </table>
          </div>

          <!-- VUE GRILLE -->
          <div id="view-grid" style="display:none;">
          <div class="cat-grid" id="cat-grid">
            {% for cat in categories_racines %}
            <div class="cat-card" data-nom="{{ cat.nom|lower }}">
              <div class="cat-card-img">
                {% if cat.image %}<img src="{{ cat.image.url }}" alt="{{ cat.nom }}" />
                {% else %}<span>üóÇ</span>{% endif %}
              </div>
              <div class="cat-card-body">
                <div class="cat-card-name">{{ cat.nom }}</div>
                <div class="cat-card-slug">/{{ cat.slug }}</div>
                <div style="margin-top:7px;display:flex;align-items:center;justify-content:space-between;">
                  <span class="badge badge-parent" style="font-size:9.5px;">üè∑ Principale</span>
                  {% if cat.est_active %}<span class="badge badge-active" style="font-size:9.5px;">Active</span>
                  {% else %}<span class="badge badge-inactive" style="font-size:9.5px;">Inactive</span>{% endif %}
                </div>
              </div>
              <div class="cat-card-footer">
                <div class="cat-card-actions">
                  <a href="?modifier={{ cat.id }}" class="action-btn action-edit" style="font-size:11px;padding:4px 9px;">‚úèÔ∏è Modifier</a>
                  <button onclick="confirmSupprimerCat('{% url 'products:supprimer_categorie' cat.id %}', '{{ cat.nom }}')" class="action-btn action-del" style="font-size:11px;padding:4px 9px;">üóë</button>
                </div>
              </div>
            </div>
            {% for sous in cat.sous_categories.all %}
            <div class="cat-card" data-nom="{{ sous.nom|lower }}" style="background:#fafbff;">
              <div class="cat-card-img">
                {% if sous.image %}<img src="{{ sous.image.url }}" alt="{{ sous.nom }}" />
                {% else %}<span>üìÅ</span>{% endif %}
              </div>
              <div class="cat-card-body">
                <div class="cat-card-name" style="font-size:12px;">‚Ü≥ {{ sous.nom }}</div>
                <div class="cat-card-slug">/{{ sous.slug }}</div>
                <div style="margin-top:7px;display:flex;align-items:center;justify-content:space-between;">
                  <span class="badge badge-sous" style="font-size:9.5px;">üìÇ Sous-cat.</span>
                  {% if sous.est_active %}<span class="badge badge-active" style="font-size:9.5px;">Active</span>
                  {% else %}<span class="badge badge-inactive" style="font-size:9.5px;">Inactive</span>{% endif %}
                </div>
              </div>
              <div class="cat-card-footer">
                <div class="cat-card-actions">
                  <a href="?modifier={{ sous.id }}" class="action-btn action-edit" style="font-size:11px;padding:4px 9px;">‚úèÔ∏è Modifier</a>
                  <button onclick="confirmSupprimerCat('{% url 'products:supprimer_categorie' sous.id %}', '{{ sous.nom }}')" class="action-btn action-del" style="font-size:11px;padding:4px 9px;">üóë</button>
                </div>
              </div>
            </div>
            {% endfor %}
            {% endfor %}
          </div>
          </div>

          {% else %}
          <div class="empty-state">
            <div class="icon">üóÇ</div>
            <p>Aucune cat√©gorie cr√©√©e pour l'instant.<br>Utilisez le formulaire pour commencer.</p>
          </div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>

<!-- MODAL SUPPRESSION -->
<div id="modal-del-cat" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-icon">‚ö†Ô∏è</div>
    <div class="modal-title">Supprimer cette cat√©gorie ?</div>
    <p class="modal-body" id="modal-del-body">Action irr√©versible. Les produits associ√©s seront sans cat√©gorie.</p>
    <div class="btn-row" style="justify-content:flex-end;">
      <button onclick="document.getElementById('modal-del-cat').classList.add('hidden')" class="btn-secondary">Annuler</button>
      <form method="POST" id="del-cat-form">
        {% csrf_token %}
        <button type="submit" style="padding:11px 20px;border-radius:9px;border:none;cursor:pointer;background:var(--red);color:white;font-weight:600;font-family:'DM Sans',sans-serif;font-size:13px;display:inline-flex;align-items:center;gap:7px;">üóë Confirmer</button>
      </form>
    </div>
  </div>
</div>

<script>
// Compter racines/sous
(function() {
  const rows = document.querySelectorAll('#cat-tbody tr');
  let racines = 0, sous = 0;
  rows.forEach(r => r.classList.contains('cat-row-sub') ? sous++ : racines++);
  document.getElementById('nb-racines').textContent = racines;
  document.getElementById('nb-sous').textContent = sous;
})();

// ‚îÄ‚îÄ Toggle vue tableau / grille ‚îÄ‚îÄ
let currentView = localStorage.getItem('cat_view') || 'table';

function setView(v) {
  currentView = v;
  localStorage.setItem('cat_view', v);
  document.getElementById('view-table').style.display = v === 'table' ? '' : 'none';
  document.getElementById('view-grid').style.display  = v === 'grid'  ? '' : 'none';
  document.getElementById('btn-table').classList.toggle('active', v === 'table');
  document.getElementById('btn-grid').classList.toggle('active',  v === 'grid');
  // re-appliquer filtre actif
  const q = document.getElementById('cat-search').value;
  if (q) filterCats(q);
}

// Appliquer la vue sauvegard√©e au chargement
setView(currentView);

// ‚îÄ‚îÄ Filtrer dans les deux vues ‚îÄ‚îÄ
function filterCats(val) {
  const v = val.toLowerCase();
  // Tableau
  document.querySelectorAll('#cat-tbody tr').forEach(row => {
    const nom = row.getAttribute('data-nom') || '';
    row.style.display = nom.includes(v) ? '' : 'none';
  });
  // Grille
  document.querySelectorAll('#cat-grid .cat-card').forEach(card => {
    const nom = card.getAttribute('data-nom') || '';
    card.style.display = nom.includes(v) ? '' : 'none';
  });
}

// ‚îÄ‚îÄ Modal suppression ‚îÄ‚îÄ
function confirmSupprimerCat(url, nom) {
  document.getElementById('modal-del-body').innerHTML =
    'Action <strong>irr√©versible</strong>. La cat√©gorie ¬´&nbsp;<strong>' + nom + '</strong>&nbsp;¬ª sera supprim√©e. Les produits associ√©s seront sans cat√©gorie.';
  document.getElementById('del-cat-form').action = url;
  document.getElementById('modal-del-cat').classList.remove('hidden');
}

// ‚îÄ‚îÄ Preview image ‚îÄ‚îÄ
function previewImage(input) {
  const preview = document.getElementById('img-preview-new');
  const wrap    = document.getElementById('img-preview-new-wrap');
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = e => {
      preview.src = e.target.result;
      preview.style.display = 'block';
      if (wrap) wrap.style.display = 'none';
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function handleDropCat(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    const input = document.getElementById('id_image');
    const dt = new DataTransfer();
    dt.items.add(files[0]);
    input.files = dt.files;
    previewImage(input);
  }
}

function resetForm() {
  document.getElementById('img-preview-new').style.display = 'none';
  document.getElementById('img-preview-new-wrap').style.display = 'block';
}

{% if categorie_edit %}
document.getElementById('form-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
{% endif %}
</script>
{% endblock %}