{% extends 'base.html' %}
{% load static %}

{% block title %}{% if produit %}Modifier â€” {% endif %}Ajouter un produit â€” HooYia Market{% endblock %}

{% block extra_head %}
<style>
:root {
  --navy:     #0D1F5C;
  --blue:     #1E3A8A;
  --orange:   #F97316;
  --orange-d: #ea6000;
  --green:    #10b981;
  --red:      #ef4444;
  --bg:       #f0f3fa;
  --border:   #e2e8f8;
  --shadow:   0 1px 4px rgba(13,31,92,.07);
}
body { background: var(--bg) !important; }
.page-root { display: flex; min-height: calc(100vh - 64px); }
.sidebar { width: 220px; flex-shrink: 0; background: var(--navy); position: sticky; top: 0; height: 100vh; display: flex; flex-direction: column; overflow-y: auto; }
.sb-head { padding: 20px 16px 14px; border-bottom: 1px solid rgba(255,255,255,.08); }
.sb-logo { font-weight: 800; font-size: 16px; color: var(--orange); }
.sb-sub  { font-size: 11px; color: rgba(255,255,255,.35); margin-top: 2px; }
.sb-lbl  { font-size: 9.5px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: rgba(255,255,255,.28); padding: 12px 16px 3px; }
.sb-item { display: flex; align-items: center; gap: 9px; padding: 9px 16px; font-size: 12.5px; font-weight: 500; color: rgba(255,255,255,.58); text-decoration: none; border-left: 3px solid transparent; transition: all .12s; }
.sb-item:hover { color: rgba(255,255,255,.9); background: rgba(255,255,255,.05); border-left-color: rgba(255,255,255,.15); }
.sb-item.active { color: white; background: rgba(249,115,22,.18); border-left-color: var(--orange); font-weight: 600; }
.main-content { flex: 1; padding: 28px 36px; overflow-x: auto; }
.page-back { font-size: 12px; color: rgba(13,31,92,.4); text-decoration: none; display: inline-flex; align-items: center; gap: 4px; margin-bottom: 6px; }
.page-back:hover { color: var(--orange); }
.page-title { font-size: 22px; font-weight: 700; color: var(--navy); margin-bottom: 20px; }
.card { background: white; border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 20px; }
.card-head { padding: 14px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
.card-head-icon { width: 34px; height: 34px; border-radius: 8px; background: linear-gradient(135deg, var(--orange), var(--orange-d)); display: flex; align-items: center; justify-content: center; font-size: 15px; }
.card-head-title { font-size: 13.5px; font-weight: 700; color: var(--navy); }
.card-body { padding: 20px; }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
.field-group { margin-bottom: 14px; }
.field-label { display: block; font-size: 11.5px; font-weight: 700; color: var(--navy); margin-bottom: 5px; text-transform: uppercase; letter-spacing: .5px; }
.field-label span { font-weight: 400; color: rgba(13,31,92,.35); text-transform: none; letter-spacing: 0; margin-left: 4px; }
.field-input { width: 100%; padding: 9px 12px; border-radius: 8px; border: 1.5px solid var(--border); font-size: 13.5px; color: #111; font-family: 'DM Sans', sans-serif; background: #fafbff; transition: border .15s, box-shadow .15s; box-sizing: border-box; }
.field-input:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(30,58,138,.1); background: white; }
.field-textarea { resize: vertical; min-height: 90px; }
.field-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%230D1F5C' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; cursor: pointer; }
.field-error { font-size: 11.5px; color: var(--red); margin-top: 4px; }
.input-wrap { position: relative; }
.input-suffix { position: absolute; right: 11px; top: 50%; transform: translateY(-50%); font-size: 11px; color: rgba(13,31,92,.35); font-weight: 600; pointer-events: none; }
.toggle { position: relative; display: inline-block; width: 44px; height: 24px; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; inset: 0; border-radius: 24px; background: #d1d5e8; cursor: pointer; transition: .2s; }
.toggle-slider:before { content: ''; position: absolute; width: 18px; height: 18px; border-radius: 50%; background: white; left: 3px; top: 3px; transition: .2s; box-shadow: 0 1px 3px rgba(0,0,0,.2); }
.toggle input:checked + .toggle-slider { background: var(--green); }
.toggle input:checked + .toggle-slider:before { transform: translateX(20px); }
.btn-primary { padding: 10px 22px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif; background: linear-gradient(135deg, var(--orange), var(--orange-d)); color: white; box-shadow: 0 2px 8px rgba(249,115,22,.3); transition: all .15s; display: inline-flex; align-items: center; gap: 7px; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(249,115,22,.4); }
.btn-secondary { padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif; background: white; color: var(--navy); border: 1.5px solid var(--border); transition: all .15s; display: inline-flex; align-items: center; gap: 7px; text-decoration: none; }
.btn-secondary:hover { border-color: var(--blue); background: #f0f3fa; }
.btn-danger { padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif; background: #fff5f5; color: var(--red); border: 1.5px solid #fecaca; transition: all .15s; display: inline-flex; align-items: center; gap: 7px; }
.btn-danger:hover { background: #fee2e2; }
.btn-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.flash { padding: 11px 16px; border-radius: 8px; font-size: 13px; font-weight: 500; margin-bottom: 18px; display: flex; align-items: center; gap: 8px; }
.flash-success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
.flash-error   { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
.drop-zone { border: 2px dashed var(--border); border-radius: 10px; padding: 28px; text-align: center; cursor: pointer; transition: border .15s, background .15s; background: #fafbff; }
.drop-zone:hover, .drop-zone.drag-over { border-color: var(--blue); background: #f0f4ff; }
.img-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px; }
.img-thumb { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; }
.img-thumb img { width: 100%; height: 100%; object-fit: cover; }
.badge-principal { position: absolute; top: 4px; left: 4px; background: var(--blue); color: white; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
.btn-del-img { position: absolute; top: 4px; right: 4px; background: rgba(239,68,68,.9); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; cursor: pointer; opacity: 0; transition: opacity .15s; display: flex; align-items: center; justify-content: center; }
.img-thumb:hover .btn-del-img { opacity: 1; }
.remise-badge { display: inline-block; background: #d1fae5; color: #065f46; font-size: 12px; font-weight: 600; padding: 2px 10px; border-radius: 20px; margin-top: 5px; }
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.55); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
.modal-box { background: white; border-radius: 14px; padding: 28px; max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,.2); }
@media (max-width: 900px) { .sidebar { display: none; } .main-content { padding: 20px 16px; } .grid-2 { grid-template-columns: 1fr; } .img-grid { grid-template-columns: repeat(3,1fr); } }
</style>
{% endblock %}

{% block content %}
<div class="page-root">

  <aside class="sidebar">
    <div class="sb-head">
      <div class="sb-logo">&#9881; Admin</div>
      <div class="sb-sub">HooYia Market</div>
    </div>
    <div class="sb-lbl">Navigation</div>
    <a href="{% url 'products:admin_dashboard' %}" class="sb-item">&#128202; Dashboard</a>
    <div class="sb-lbl">Catalogue</div>
    <a href="{% url 'products:gestion_categories' %}" class="sb-item">&#128193; Cat&#233;gories</a>
    <a href="{% url 'products:liste' %}" class="sb-item">&#128230; Produits</a>
    <a href="{% url 'products:ajouter' %}" class="sb-item active">&#10133; {% if produit %}Modifier produit{% else %}Ajouter produit{% endif %}</a>
    <div class="sb-lbl">Site</div>
    <a href="{% url 'products:accueil' %}" class="sb-item">&#127968; Voir le site</a>
  </aside>

  <div class="main-content">
    <a href="{% url 'products:admin_dashboard' %}" class="page-back">&#8592; Dashboard</a>
    <div class="page-title">{% if produit %}&#9999;&#65039; Modifier &laquo; {{ produit.nom }} &raquo;{% else %}&#10133; Nouveau produit{% endif %}</div>

    {% for message in messages %}
    <div class="flash {% if message.tags == 'success' %}flash-success{% else %}flash-error{% endif %}">
      {% if message.tags == 'success' %}&#10003;{% else %}&#10005;{% endif %} {{ message }}
    </div>
    {% endfor %}

    <form method="POST" enctype="multipart/form-data" id="product-form">
      {% csrf_token %}

      <div class="card">
        <div class="card-head"><div class="card-head-icon">&#128221;</div><div class="card-head-title">Informations de base</div></div>
        <div class="card-body">
          <div class="field-group">
            <label class="field-label" for="id_nom">Nom du produit <span>(obligatoire)</span></label>
            <input type="text" name="nom" id="id_nom" value="{{ form.nom.value|default:'' }}" placeholder="Ex: Samsung Galaxy S24 Ultra 256Go" class="field-input" required />
            {% if form.nom.errors %}<p class="field-error">{{ form.nom.errors.0 }}</p>{% endif %}
          </div>
          <div class="field-group">
            <label class="field-label" for="id_description_courte">Description courte <span>(max 500 caract&#232;res)</span></label>
            <input type="text" name="description_courte" id="id_description_courte" value="{{ form.description_courte.value|default:'' }}" placeholder="R&#233;sum&#233; affich&#233; dans la liste produits" maxlength="500" class="field-input" />
          </div>
          <div class="field-group">
            <label class="field-label" for="id_description">Description compl&#232;te <span>(obligatoire)</span></label>
            <textarea name="description" id="id_description" rows="5" placeholder="Description d&#233;taill&#233;e : caract&#233;ristiques, contenu de la bo&#238;te, garantie&#8230;" class="field-input field-textarea" required>{{ form.description.value|default:'' }}</textarea>
            {% if form.description.errors %}<p class="field-error">{{ form.description.errors.0 }}</p>{% endif %}
          </div>
          <div class="field-group">
            <label class="field-label" for="id_categorie">Cat&#233;gorie <span>(obligatoire)</span></label>
            <select name="categorie" id="id_categorie" class="field-input field-select" required>
              <option value="">&#8212; Choisir une cat&#233;gorie &#8212;</option>
              {% for cat in categories %}
              <option value="{{ cat.id }}" {% if form.categorie.value == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.nom }}</option>
              {% for sous in cat.sous_categories.all %}
              <option value="{{ sous.id }}" {% if form.categorie.value == sous.id|stringformat:"s" %}selected{% endif %}>&#160;&#160;&#8627; {{ sous.nom }}</option>
              {% endfor %}
              {% endfor %}
            </select>
            {% if form.categorie.errors %}<p class="field-error">{{ form.categorie.errors.0 }}</p>{% endif %}
            <div style="margin-top:6px;"><a href="{% url 'products:gestion_categories' %}" target="_blank" style="font-size:12px;color:var(--orange);text-decoration:none;font-weight:600;">+ Cr&#233;er une cat&#233;gorie &#8594;</a></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><div class="card-head-icon">&#128176;</div><div class="card-head-title">Prix &amp; Stock</div></div>
        <div class="card-body">
          <div class="grid-2">
            <div class="field-group">
              <label class="field-label" for="id_prix">Prix (FCFA) <span>(obligatoire)</span></label>
              <div class="input-wrap">
                <input type="number" name="prix" id="id_prix" value="{{ form.prix.value|default:'' }}" placeholder="150000" min="0" step="500" class="field-input" style="padding-right:56px;" required />
                <span class="input-suffix">FCFA</span>
              </div>
              {% if form.prix.errors %}<p class="field-error">{{ form.prix.errors.0 }}</p>{% endif %}
            </div>
            <div class="field-group">
              <label class="field-label" for="id_prix_promo">Prix promo <span>(optionnel)</span></label>
              <div class="input-wrap">
                <input type="number" name="prix_promo" id="id_prix_promo" value="{{ form.prix_promo.value|default:'' }}" placeholder="120000" min="0" step="500" class="field-input" style="padding-right:56px;" />
                <span class="input-suffix">FCFA</span>
              </div>
              <div id="remise-preview" style="display:none;" class="remise-badge"></div>
            </div>
            <div class="field-group">
              <label class="field-label" for="id_stock">Stock <span>(obligatoire)</span></label>
              <input type="number" name="stock" id="id_stock" value="{{ form.stock.value|default:0 }}" min="0" class="field-input" required />
              {% if form.stock.errors %}<p class="field-error">{{ form.stock.errors.0 }}</p>{% endif %}
            </div>
            <div class="field-group">
              <label class="field-label" for="id_stock_minimum">Seuil d'alerte <span>(d&#233;faut : 5)</span></label>
              <input type="number" name="stock_minimum" id="id_stock_minimum" value="{{ form.stock_minimum.value|default:5 }}" min="0" class="field-input" />
              <p style="font-size:11.5px;color:rgba(13,31,92,.4);margin-top:4px;">Alerte si stock &#8804; cette valeur</p>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><div class="card-head-icon">&#9881;&#65039;</div><div class="card-head-title">Statut &amp; Options</div></div>
        <div class="card-body">
          <div class="grid-2">
            <div class="field-group">
              <label class="field-label" for="id_statut">Statut de vente</label>
              <select name="statut" id="id_statut" class="field-input field-select">
                <option value="actif"   {% if form.statut.value == 'actif'   or not form.statut.value %}selected{% endif %}>&#9989; Actif &#8212; visible et en vente</option>
                <option value="inactif" {% if form.statut.value == 'inactif' %}selected{% endif %}>&#128274; Inactif &#8212; masqu&#233;</option>
                <option value="epuise"  {% if form.statut.value == 'epuise'  %}selected{% endif %}>&#10060; &#201;puis&#233;</option>
                <option value="archive" {% if form.statut.value == 'archive' %}selected{% endif %}>&#128230; Archiv&#233;</option>
              </select>
            </div>
            <div class="field-group" style="display:flex;align-items:center;gap:12px;padding-top:28px;">
              <label class="toggle">
                <input type="checkbox" name="en_vedette" id="id_en_vedette" {% if form.en_vedette.value %}checked{% endif %}>
                <span class="toggle-slider"></span>
              </label>
              <div>
                <div style="font-size:13px;font-weight:600;color:var(--navy);">Produit en vedette</div>
                <div style="font-size:11.5px;color:rgba(13,31,92,.4);">Affich&#233; sur la page d'accueil</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><div class="card-head-icon">&#128444;&#65039;</div><div class="card-head-title">Images du produit</div></div>
        <div class="card-body">
          {% if produit and produit.images.all %}
          <p style="font-size:12px;font-weight:700;color:var(--navy);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;">Images actuelles</p>
          <div class="img-grid" style="margin-bottom:18px;">
            {% for img in produit.images.all %}
            <div class="img-thumb">
              <img src="{{ img.image.url }}" alt="" />
              {% if img.est_principale %}<span class="badge-principal">Principal</span>{% endif %}
              <button type="button" class="btn-del-img" onclick="supprimerImage({{ img.id }}, this)">&#10005;</button>
            </div>
            {% endfor %}
          </div>
          <p style="font-size:12px;font-weight:700;color:var(--navy);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;">Ajouter des images</p>
          {% endif %}
          <div class="drop-zone" id="drop-zone"
            onclick="document.getElementById('id_images').click()"
            ondragover="event.preventDefault(); this.classList.add('drag-over')"
            ondragleave="this.classList.remove('drag-over')"
            ondrop="handleDrop(event)">
            <div style="font-size:32px;margin-bottom:8px;">&#128247;</div>
            <p style="font-size:13px;color:rgba(13,31,92,.5);"><strong style="color:var(--orange);">Cliquez</strong> ou glissez vos images ici</p>
            <p style="font-size:12px;color:rgba(13,31,92,.35);">JPG, PNG, WebP &#8212; Max 5 Mo/image &#8212; 1&#232;re image = principale</p>
          </div>
          <input type="file" name="images" id="id_images" multiple accept="image/*" onchange="previewImages(this.files)" style="display:none;" />
          <div id="preview-grid" class="img-grid"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="btn-row" style="justify-content:space-between;">
            <div>
              {% if produit %}
              <button type="button" class="btn-danger" onclick="document.getElementById('modal-del').classList.remove('hidden')">&#128465; Supprimer le produit</button>
              {% endif %}
            </div>
            <div class="btn-row">
              <a href="{% url 'products:admin_dashboard' %}" class="btn-secondary">Annuler</a>
              <button type="submit" name="action" value="draft" class="btn-secondary">&#128190; Brouillon</button>
              <button type="submit" name="action" value="publish" class="btn-primary">{% if produit %}&#10003; Enregistrer{% else %}&#128640; Publier le produit{% endif %}</button>
            </div>
          </div>
        </div>
      </div>

    </form>

    {% if produit %}
    <div id="modal-del" class="modal-overlay hidden">
      <div class="modal-box">
        <div style="font-size:32px;margin-bottom:10px;">&#9888;&#65039;</div>
        <div style="font-size:17px;font-weight:700;color:var(--navy);margin-bottom:8px;">Supprimer ce produit ?</div>
        <p style="font-size:13px;color:#666;margin-bottom:20px;">Action <strong>irr&#233;versible</strong>. Le produit &laquo; {{ produit.nom }} &raquo; sera d&#233;finitivement supprim&#233;.</p>
        <div class="btn-row">
          <button onclick="document.getElementById('modal-del').classList.add('hidden')" class="btn-secondary" style="flex:1;">Annuler</button>
          <form method="POST" action="/produits/supprimer/{{ produit.id }}/" style="flex:1;">
            {% csrf_token %}
            <button type="submit" style="width:100%;padding:10px;border-radius:8px;border:none;cursor:pointer;background:var(--red);color:white;font-weight:600;font-family:'DM Sans',sans-serif;font-size:13px;">&#128465; Supprimer</button>
          </form>
        </div>
      </div>
    </div>
    {% endif %}

  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function previewImages(files) {
  const grid = document.getElementById('preview-grid');
  grid.innerHTML = '';
  Array.from(files).forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = e => {
      const div = document.createElement('div');
      div.className = 'img-thumb';
      div.innerHTML = '<img src="' + e.target.result + '" />' + (i === 0 ? '<span class="badge-principal">Principal</span>' : '');
      grid.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
}
function handleDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const input = document.getElementById('id_images');
  const dt = new DataTransfer();
  Array.from(e.dataTransfer.files).forEach(f => dt.items.add(f));
  input.files = dt.files;
  previewImages(e.dataTransfer.files);
}
document.getElementById('id_prix_promo').addEventListener('input', function() {
  const prix = parseFloat(document.getElementById('id_prix').value);
  const promo = parseFloat(this.value);
  const preview = document.getElementById('remise-preview');
  if (prix && promo && promo < prix) {
    preview.textContent = 'âˆ’ ' + Math.round(((prix - promo) / prix) * 100) + '% de remise';
    preview.style.display = 'inline-block';
  } else { preview.style.display = 'none'; }
});
document.getElementById('id_prix').addEventListener('input', () => {
  document.getElementById('id_prix_promo').dispatchEvent(new Event('input'));
});
async function supprimerImage(imageId, btn) {
  // Modal confirm personnalisÃ©
  const confirmed = await new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:300;display:flex;align-items:center;justify-content:center;padding:20px;';
    overlay.innerHTML = `<div style="background:white;border-radius:16px;max-width:380px;width:100%;box-shadow:0 24px 64px rgba(0,0,0,.25);overflow:hidden;">
      <div style="background:#fff5f5;padding:18px 22px;display:flex;align-items:center;gap:10px;">
        <div style="width:40px;height:40px;border-radius:10px;background:#fee2e2;display:flex;align-items:center;justify-content:center;font-size:18px;">ðŸ—‘</div>
        <div style="font-size:14px;font-weight:700;color:#991b1b;">Supprimer cette image ?</div>
      </div>
      <div style="padding:14px 22px 18px;font-size:13px;color:#64748b;">L'image sera dÃ©finitivement supprimÃ©e du produit.</div>
      <div style="padding:0 22px 18px;display:flex;gap:8px;justify-content:flex-end;">
        <button id="_no" style="padding:8px 16px;border-radius:7px;border:1.5px solid #e2e8f8;background:white;font-weight:600;font-size:12px;cursor:pointer;color:#64748b;">Annuler</button>
        <button id="_yes" style="padding:8px 16px;border-radius:7px;border:none;background:#ef4444;color:white;font-weight:600;font-size:12px;cursor:pointer;">ðŸ—‘ Supprimer</button>
      </div>
    </div>`;
    document.body.appendChild(overlay);
    overlay.querySelector('#_yes').onclick = () => { document.body.removeChild(overlay); resolve(true); };
    overlay.querySelector('#_no').onclick  = () => { document.body.removeChild(overlay); resolve(false); };
  });
  if (!confirmed) return;
  try {
    const resp = await fetch('/api/produits/images/' + imageId + '/', {
      method: 'DELETE',
      headers: { 'X-CSRFToken': document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '' }
    });
    if (resp.ok || resp.status === 204) btn.closest('.img-thumb').remove();
  } catch(e) { console.error(e); }
}
</script>
{% endblock %}