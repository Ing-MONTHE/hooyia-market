{% extends 'base.html' %}
{% load static %}

{% block title %}{% if produit %}Modifier ‚Äî {% endif %}Ajouter un produit ‚Äî HooYia Market{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --navy:     #0D1F5C;
  --blue:     #1E3A8A;
  --orange:   #F97316;
  --orange-d: #ea6000;
  --green:    #10b981;
  --red:      #ef4444;
  --bg:       #f0f3fa;
  --border:   #e2e8f8;
  --shadow:   0 1px 6px rgba(13,31,92,.08);
  --shadow-md:0 4px 20px rgba(13,31,92,.12);
}
*, *::before, *::after { box-sizing: border-box; }
body { background: var(--bg) !important; font-family: 'DM Sans', sans-serif; }
.page-root { display: flex; min-height: calc(100vh - 64px); }
.sidebar { width: 230px; flex-shrink: 0; background: linear-gradient(180deg, #0a1840 0%, #0D1F5C 100%); position: sticky; top: 0; height: 100vh; display: flex; flex-direction: column; overflow-y: auto; border-right: 1px solid rgba(255,255,255,.06); }
.sb-head { padding: 22px 18px 16px; border-bottom: 1px solid rgba(255,255,255,.08); }
.sb-logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 17px; color: var(--orange); }
.sb-sub  { font-size: 10.5px; color: rgba(255,255,255,.3); margin-top: 2px; }
.sb-lbl  { font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: rgba(255,255,255,.22); padding: 14px 18px 4px; }
.sb-item { display: flex; align-items: center; gap: 9px; padding: 9px 18px; font-size: 12.5px; font-weight: 500; color: rgba(255,255,255,.5); text-decoration: none; border-left: 3px solid transparent; transition: all .12s; }
.sb-item:hover { color: rgba(255,255,255,.9); background: rgba(255,255,255,.05); border-left-color: rgba(255,255,255,.15); }
.sb-item.active { color: white; background: rgba(249,115,22,.15); border-left-color: var(--orange); font-weight: 600; }
.sb-bottom { margin-top: auto; padding: 16px 18px; border-top: 1px solid rgba(255,255,255,.07); }
.sb-version { font-size: 10px; color: rgba(255,255,255,.2); }
.main-content { flex: 1; padding: 32px 40px; max-width: 860px; }
.page-back { font-size: 11.5px; color: rgba(13,31,92,.4); text-decoration: none; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 8px; transition: color .12s; }
.page-back:hover { color: var(--orange); }
.page-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 28px; gap: 16px; }
.page-title { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; color: var(--navy); letter-spacing: -.4px; }
.page-subtitle { font-size: 13px; color: rgba(13,31,92,.45); margin-top: 3px; }
.card { background: white; border-radius: 14px; border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 18px; transition: box-shadow .2s; }
.card:hover { box-shadow: var(--shadow-md); }
.card-head { padding: 16px 22px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
.card-head-icon { width: 36px; height: 36px; border-radius: 9px; background: linear-gradient(135deg, var(--orange), var(--orange-d)); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; box-shadow: 0 2px 8px rgba(249,115,22,.25); }
.card-head-title { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; color: var(--navy); }
.card-head-sub { font-size: 11.5px; color: rgba(13,31,92,.4); }
.card-body { padding: 22px; }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
.field-group { margin-bottom: 16px; }
.field-group:last-child { margin-bottom: 0; }
.field-label { display: block; font-size: 11px; font-weight: 700; color: var(--navy); margin-bottom: 6px; text-transform: uppercase; letter-spacing: .8px; }
.field-label span { font-weight: 400; color: rgba(13,31,92,.35); text-transform: none; letter-spacing: 0; margin-left: 4px; font-size: 11px; }
.field-input { width: 100%; padding: 10px 13px; border-radius: 9px; border: 1.5px solid var(--border); font-size: 13.5px; color: #111; font-family: 'DM Sans', sans-serif; background: #fafbff; transition: border .15s, box-shadow .15s; }
.field-input:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(30,58,138,.1); background: white; }
.field-input:hover:not(:focus) { border-color: #c4cee8; }
.field-textarea { resize: vertical; min-height: 95px; line-height: 1.5; }
.field-select { appearance: none; cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%230D1F5C' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 13px center; padding-right: 38px; }
.field-error { font-size: 11.5px; color: var(--red); margin-top: 5px; }
.field-hint { font-size: 11.5px; color: rgba(13,31,92,.4); margin-top: 4px; }
.input-wrap { position: relative; }
.input-suffix { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 11px; color: rgba(13,31,92,.35); font-weight: 700; pointer-events: none; background: var(--border); padding: 2px 7px; border-radius: 4px; }
.remise-badge { display: inline-block; background: #d1fae5; color: #065f46; font-size: 12px; font-weight: 600; padding: 3px 12px; border-radius: 20px; margin-top: 6px; }
.toggle-row { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 9px; background: #fafbff; border: 1.5px solid var(--border); }
.toggle { position: relative; display: inline-block; width: 46px; height: 25px; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; inset: 0; border-radius: 25px; background: #d1d5e8; cursor: pointer; transition: .2s; }
.toggle-slider:before { content: ''; position: absolute; width: 19px; height: 19px; border-radius: 50%; background: white; left: 3px; top: 3px; transition: .2s; box-shadow: 0 1px 4px rgba(0,0,0,.2); }
.toggle input:checked + .toggle-slider { background: var(--green); }
.toggle input:checked + .toggle-slider:before { transform: translateX(21px); }
.toggle-info { flex: 1; }
.toggle-title { font-size: 13px; font-weight: 600; color: var(--navy); }
.toggle-desc { font-size: 11.5px; color: rgba(13,31,92,.4); margin-top: 1px; }
.btn-primary { padding: 11px 24px; border-radius: 9px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif; background: linear-gradient(135deg, var(--orange), var(--orange-d)); color: white; box-shadow: 0 2px 10px rgba(249,115,22,.3); transition: all .15s; display: inline-flex; align-items: center; gap: 7px; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 5px 18px rgba(249,115,22,.4); }
.btn-secondary { padding: 11px 20px; border-radius: 9px; cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif; background: white; color: var(--navy); border: 1.5px solid var(--border); transition: all .15s; display: inline-flex; align-items: center; gap: 7px; text-decoration: none; }
.btn-secondary:hover { border-color: var(--blue); background: #f4f6fd; }
.btn-danger { padding: 11px 20px; border-radius: 9px; cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif; background: #fff5f5; color: var(--red); border: 1.5px solid #fecaca; transition: all .15s; display: inline-flex; align-items: center; gap: 7px; }
.btn-danger:hover { background: #fee2e2; border-color: var(--red); }
.btn-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.flash { padding: 12px 18px; border-radius: 9px; font-size: 13px; font-weight: 500; margin-bottom: 20px; display: flex; align-items: center; gap: 9px; animation: slideIn .2s ease; }
.flash-success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
.flash-error   { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
@keyframes slideIn { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: none; } }
.drop-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 32px 20px; text-align: center; cursor: pointer; transition: all .2s; background: #fafbff; }
.drop-zone:hover, .drop-zone.drag-over { border-color: var(--blue); background: #f0f4ff; }
.img-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 14px; }
.img-thumb { position: relative; border-radius: 10px; overflow: hidden; aspect-ratio: 1; background: var(--border); box-shadow: var(--shadow); }
.img-thumb img { width: 100%; height: 100%; object-fit: cover; }
.badge-principal { position: absolute; top: 5px; left: 5px; background: var(--blue); color: white; font-size: 8.5px; font-weight: 700; padding: 2px 7px; border-radius: 4px; }
.btn-del-img { position: absolute; top: 5px; right: 5px; background: rgba(239,68,68,.92); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 10px; cursor: pointer; opacity: 0; transition: opacity .15s; display: flex; align-items: center; justify-content: center; }
.img-thumb:hover .btn-del-img { opacity: 1; }
.section-label { font-size: 10.5px; font-weight: 700; color: rgba(13,31,92,.4); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
.action-bar { background: white; border: 1px solid var(--border); border-radius: 14px; padding: 16px 22px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-md); margin-bottom: 40px; position: sticky; bottom: 20px; z-index: 10; }
.action-bar-right { display: flex; gap: 10px; }
.cat-shortcut { display: inline-flex; align-items: center; gap: 5px; font-size: 12px; color: var(--orange); text-decoration: none; font-weight: 600; margin-top: 6px; transition: opacity .12s; }
.cat-shortcut:hover { opacity: .75; }
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(2px); }
.modal-overlay.hidden { display: none; }
.modal-box { background: white; border-radius: 16px; padding: 30px; max-width: 420px; width: 100%; box-shadow: 0 24px 72px rgba(0,0,0,.25); animation: modalIn .2s ease; }
@keyframes modalIn { from { opacity: 0; transform: scale(.96) translateY(8px); } to { opacity: 1; transform: none; } }
.modal-icon { font-size: 36px; margin-bottom: 12px; }
.modal-title { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; color: var(--navy); margin-bottom: 8px; }
.modal-body { font-size: 13px; color: #64748b; margin-bottom: 22px; line-height: 1.6; }
@media (max-width: 900px) { .sidebar { display: none; } .main-content { padding: 20px 16px; max-width: 100%; } .grid-2 { grid-template-columns: 1fr; } .img-grid { grid-template-columns: repeat(3, 1fr); } .action-bar { flex-direction: column; gap: 12px; } }
</style>
{% endblock %}

{% block content %}
<div class="page-root">

  <aside class="sidebar">
    <div class="sb-head">
      <div class="sb-logo">‚öô Admin</div>
      <div class="sb-sub">HooYia Market</div>
    </div>
    <div class="sb-lbl">Navigation</div>
    <a href="{% url 'products:admin_dashboard' %}" class="sb-item">üìä Dashboard</a>
    <div class="sb-lbl">Catalogue</div>
    <a href="{% url 'products:gestion_categories' %}" class="sb-item">üóÇ Cat√©gories</a>
    <a href="{% url 'products:liste' %}" class="sb-item">üì¶ Produits</a>
    <a href="{% url 'products:ajouter' %}" class="sb-item active">‚ûï {% if produit %}Modifier{% else %}Ajouter produit{% endif %}</a>
    <div class="sb-lbl">Site</div>
    <a href="{% url 'products:accueil' %}" class="sb-item">üè† Voir le site</a>
    <div class="sb-bottom"><div class="sb-version">HooYia Market v1.0</div></div>
  </aside>

  <div class="main-content">
    <a href="{% url 'products:admin_dashboard' %}" class="page-back">‚Üê Retour au Dashboard</a>
    <div class="page-header">
      <div>
        <div class="page-title">{% if produit %}‚úèÔ∏è Modifier ¬´&nbsp;{{ produit.nom }}&nbsp;¬ª{% else %}‚ûï Nouveau produit{% endif %}</div>
        <div class="page-subtitle">{% if produit %}Mettez √† jour les informations de ce produit{% else %}Remplissez les informations pour publier un nouveau produit{% endif %}</div>
      </div>
      {% if produit %}
      <a href="{% url 'products:detail' produit.slug %}" target="_blank" class="btn-secondary" style="flex-shrink:0;">üëÅ Voir</a>
      {% endif %}
    </div>

    {% for message in messages %}
    <div class="flash {% if message.tags == 'success' %}flash-success{% else %}flash-error{% endif %}">
      {% if message.tags == 'success' %}‚úì{% else %}‚úï{% endif %} {{ message }}
    </div>
    {% endfor %}

    <form method="POST" enctype="multipart/form-data" id="product-form">
      {% csrf_token %}

      <!-- 1. Informations de base -->
      <div class="card">
        <div class="card-head">
          <div class="card-head-icon">üìù</div>
          <div>
            <div class="card-head-title">Informations de base</div>
            <div class="card-head-sub">Nom, description et cat√©gorie du produit</div>
          </div>
        </div>
        <div class="card-body">
          <div class="field-group">
            <label class="field-label" for="id_nom">Nom du produit <span>(obligatoire)</span></label>
            <input type="text" name="nom" id="id_nom" value="{{ form.nom.value|default:'' }}" placeholder="Ex: Samsung Galaxy S24 Ultra 256Go" class="field-input" required autocomplete="off" />
            {% if form.nom.errors %}<p class="field-error">‚ö† {{ form.nom.errors.0 }}</p>{% endif %}
          </div>
          <div class="field-group">
            <label class="field-label" for="id_description_courte">Description courte <span>(max 500 caract√®res)</span></label>
            <input type="text" name="description_courte" id="id_description_courte" value="{{ form.description_courte.value|default:'' }}" placeholder="R√©sum√© accrocheur affich√© en liste produits‚Ä¶" maxlength="500" class="field-input" />
            <div class="field-hint" id="desc-courte-counter" style="text-align:right;"></div>
          </div>
          <div class="field-group">
            <label class="field-label" for="id_description">Description compl√®te <span>(obligatoire)</span></label>
            <textarea name="description" id="id_description" rows="5" placeholder="Description d√©taill√©e : caract√©ristiques, contenu de la bo√Æte, garantie‚Ä¶" class="field-input field-textarea" required>{{ form.description.value|default:'' }}</textarea>
            {% if form.description.errors %}<p class="field-error">‚ö† {{ form.description.errors.0 }}</p>{% endif %}
          </div>
          <div class="field-group">
            <label class="field-label" for="id_categorie">Cat√©gorie <span>(obligatoire)</span></label>
            <select name="categorie" id="id_categorie" class="field-input field-select" required>
              <option value="">‚Äî Choisir une cat√©gorie ‚Äî</option>
              {% for cat in categories %}
              <option value="{{ cat.id }}" {% if form.categorie.value == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.nom }}</option>
              {% for sous in cat.sous_categories.all %}
              <option value="{{ sous.id }}" {% if form.categorie.value == sous.id|stringformat:"s" %}selected{% endif %}>  ‚Ü≥ {{ sous.nom }}</option>
              {% endfor %}
              {% endfor %}
            </select>
            {% if form.categorie.errors %}<p class="field-error">‚ö† {{ form.categorie.errors.0 }}</p>{% endif %}
            <a href="{% url 'products:gestion_categories' %}" target="_blank" class="cat-shortcut">+ Cr√©er une cat√©gorie ‚Üí</a>
          </div>
        </div>
      </div>

      <!-- 2. Prix & Stock -->
      <div class="card">
        <div class="card-head">
          <div class="card-head-icon">üí∞</div>
          <div>
            <div class="card-head-title">Prix &amp; Stock</div>
            <div class="card-head-sub">Tarification et gestion des quantit√©s</div>
          </div>
        </div>
        <div class="card-body">
          <div class="grid-2">
            <div class="field-group">
              <label class="field-label" for="id_prix">Prix <span>(obligatoire)</span></label>
              <div class="input-wrap">
                <input type="number" name="prix" id="id_prix" value="{{ form.prix.value|default:'' }}" placeholder="150000" min="0" step="500" class="field-input" style="padding-right:62px;" required />
                <span class="input-suffix">FCFA</span>
              </div>
              {% if form.prix.errors %}<p class="field-error">‚ö† {{ form.prix.errors.0 }}</p>{% endif %}
            </div>
            <div class="field-group">
              <label class="field-label" for="id_prix_promo">Prix promo <span>(optionnel)</span></label>
              <div class="input-wrap">
                <input type="number" name="prix_promo" id="id_prix_promo" value="{{ form.prix_promo.value|default:'' }}" placeholder="120000" min="0" step="500" class="field-input" style="padding-right:62px;" />
                <span class="input-suffix">FCFA</span>
              </div>
              <div id="remise-preview" style="display:none;" class="remise-badge"></div>
            </div>
            <div class="field-group">
              <label class="field-label" for="id_stock">Stock <span>(obligatoire)</span></label>
              <input type="number" name="stock" id="id_stock" value="{{ form.stock.value|default:0 }}" min="0" class="field-input" required />
              {% if form.stock.errors %}<p class="field-error">‚ö† {{ form.stock.errors.0 }}</p>{% endif %}
              <div class="field-hint" id="stock-indicator"></div>
            </div>
            <div class="field-group">
              <label class="field-label" for="id_stock_minimum">Seuil d'alerte <span>(d√©faut : 5)</span></label>
              <input type="number" name="stock_minimum" id="id_stock_minimum" value="{{ form.stock_minimum.value|default:5 }}" min="0" class="field-input" />
              <div class="field-hint">Alerte si stock ‚â§ cette valeur</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. Statut & Options -->
      <div class="card">
        <div class="card-head">
          <div class="card-head-icon">‚öôÔ∏è</div>
          <div>
            <div class="card-head-title">Statut &amp; Options</div>
            <div class="card-head-sub">Visibilit√© et mise en avant du produit</div>
          </div>
        </div>
        <div class="card-body">
          <div class="grid-2">
            <div class="field-group">
              <label class="field-label" for="id_statut">Statut de vente</label>
              <select name="statut" id="id_statut" class="field-input field-select">
                <option value="actif"   {% if form.statut.value == 'actif'   or not form.statut.value %}selected{% endif %}>‚úÖ Actif ‚Äî visible et en vente</option>
                <option value="inactif" {% if form.statut.value == 'inactif' %}selected{% endif %}>üîí Inactif ‚Äî masqu√©</option>
                <option value="epuise"  {% if form.statut.value == 'epuise'  %}selected{% endif %}>‚ùå √âpuis√©</option>
                <option value="archive" {% if form.statut.value == 'archive' %}selected{% endif %}>üì¶ Archiv√©</option>
              </select>
            </div>
            <div class="field-group">
              <label class="field-label">Mise en avant</label>
              <div class="toggle-row">
                <label class="toggle">
                  <input type="checkbox" name="en_vedette" id="id_en_vedette" {% if form.en_vedette.value %}checked{% endif %}>
                  <span class="toggle-slider"></span>
                </label>
                <div class="toggle-info">
                  <div class="toggle-title">Produit en vedette ‚≠ê</div>
                  <div class="toggle-desc">Affich√© sur la page d'accueil</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 4. Images -->
      <div class="card">
        <div class="card-head">
          <div class="card-head-icon">üñºÔ∏è</div>
          <div>
            <div class="card-head-title">Images du produit</div>
            <div class="card-head-sub">Glissez vos images ou cliquez pour parcourir</div>
          </div>
        </div>
        <div class="card-body">
          {% if produit and produit.images.all %}
          <div class="section-label">Images actuelles</div>
          <div class="img-grid" style="margin-bottom:20px;">
            {% for img in produit.images.all %}
            <div class="img-thumb">
              <img src="{{ img.image.url }}" alt="" loading="lazy" />
              {% if img.est_principale %}<span class="badge-principal">Principal</span>{% endif %}
              <button type="button" class="btn-del-img" onclick="supprimerImage({{ img.id }}, this)" title="Supprimer">‚úï</button>
            </div>
            {% endfor %}
          </div>
          <div class="section-label">Ajouter de nouvelles images</div>
          {% endif %}
          <div class="drop-zone" id="drop-zone"
            onclick="document.getElementById('id_images').click()"
            ondragover="event.preventDefault(); this.classList.add('drag-over')"
            ondragleave="this.classList.remove('drag-over')"
            ondrop="handleDrop(event)">
            <div style="font-size:36px;margin-bottom:10px;">üì∑</div>
            <div style="font-size:13px;color:rgba(13,31,92,.55);font-weight:500;"><strong style="color:var(--orange);">Cliquez</strong> ou glissez vos images ici</div>
            <div style="font-size:11.5px;color:rgba(13,31,92,.3);margin-top:4px;">JPG, PNG, WebP ‚Äî Max 5 Mo/image ‚Äî 1√®re image = principale</div>
          </div>
          <input type="file" name="images" id="id_images" multiple accept="image/*" onchange="previewImages(this.files)" style="display:none;" />
          <div id="preview-grid" class="img-grid"></div>
        </div>
      </div>

      <!-- Action Bar -->
      <div class="action-bar">
        <div>
          {% if produit %}
          <button type="button" class="btn-danger" onclick="document.getElementById('modal-del').classList.remove('hidden')">üóë Supprimer le produit</button>
          {% endif %}
        </div>
        <div class="action-bar-right">
          <a href="{% url 'products:admin_dashboard' %}" class="btn-secondary">Annuler</a>
          <button type="submit" name="action" value="draft" class="btn-secondary">üíæ Brouillon</button>
          <button type="submit" name="action" value="publish" class="btn-primary">{% if produit %}‚úì Enregistrer{% else %}üöÄ Publier le produit{% endif %}</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% if produit %}
<div id="modal-del" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-icon">‚ö†Ô∏è</div>
    <div class="modal-title">Supprimer ce produit ?</div>
    <p class="modal-body">Action <strong>irr√©versible</strong>. Le produit ¬´&nbsp;{{ produit.nom }}&nbsp;¬ª sera d√©finitivement supprim√© ainsi que toutes ses images.</p>
    <div class="btn-row" style="justify-content:flex-end;">
      <button onclick="document.getElementById('modal-del').classList.add('hidden')" class="btn-secondary">Annuler</button>
      <form method="POST" action="{% url 'products:supprimer' produit.id %}">
        {% csrf_token %}
        <button type="submit" style="padding:11px 20px;border-radius:9px;border:none;cursor:pointer;background:var(--red);color:white;font-weight:600;font-family:'DM Sans',sans-serif;font-size:13px;display:inline-flex;align-items:center;gap:7px;">üóë Confirmer</button>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
function previewImages(files) {
  const grid = document.getElementById('preview-grid');
  grid.innerHTML = '';
  Array.from(files).forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = e => {
      const div = document.createElement('div');
      div.className = 'img-thumb';
      div.innerHTML = '<img src="' + e.target.result + '" />' + (i === 0 ? '<span class="badge-principal">Principal</span>' : '');
      grid.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
}
function handleDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const input = document.getElementById('id_images');
  const dt = new DataTransfer();
  Array.from(e.dataTransfer.files).forEach(f => dt.items.add(f));
  input.files = dt.files;
  previewImages(e.dataTransfer.files);
}
function calcRemise() {
  const prix  = parseFloat(document.getElementById('id_prix').value);
  const promo = parseFloat(document.getElementById('id_prix_promo').value);
  const badge = document.getElementById('remise-preview');
  if (prix && promo && promo < prix) {
    badge.textContent = '‚àí ' + Math.round(((prix - promo) / prix) * 100) + '% de remise';
    badge.style.display = 'inline-block';
  } else { badge.style.display = 'none'; }
}
document.getElementById('id_prix_promo').addEventListener('input', calcRemise);
document.getElementById('id_prix').addEventListener('input', calcRemise);

const descCourte = document.getElementById('id_description_courte');
const counter    = document.getElementById('desc-courte-counter');
function updateCounter() {
  const len = descCourte.value.length;
  counter.textContent = len + '/500';
  counter.style.color = len > 450 ? 'var(--orange)' : 'rgba(13,31,92,.3)';
}
descCourte.addEventListener('input', updateCounter);
updateCounter();

const stockInput = document.getElementById('id_stock');
const stockMin   = document.getElementById('id_stock_minimum');
const stockInd   = document.getElementById('stock-indicator');
function updateStock() {
  const s = parseInt(stockInput.value) || 0;
  const m = parseInt(stockMin.value) || 5;
  if (s === 0) stockInd.innerHTML = '<span style="color:var(--red);font-weight:600;">‚ö† Rupture de stock</span>';
  else if (s <= m) stockInd.innerHTML = '<span style="color:var(--orange);font-weight:600;">‚ö† Stock bas (seuil : ' + m + ')</span>';
  else stockInd.innerHTML = '<span style="color:var(--green);font-weight:600;">‚úì Stock OK</span>';
}
stockInput.addEventListener('input', updateStock);
stockMin.addEventListener('input', updateStock);
updateStock();

function getCsrf() { return document.cookie.match(/csrftoken=([^;]+)/)?.[1] || ''; }

async function supprimerImage(imageId, btn) {
  const confirmed = await showConfirm('Supprimer cette image ?', "L'image sera d√©finitivement supprim√©e du produit.");
  if (!confirmed) return;
  try {
    const resp = await fetch('/api/produits/images/' + imageId + '/', {
      method: 'DELETE',
      headers: { 'X-CSRFToken': getCsrf() }
    });
    if (resp.ok || resp.status === 204) {
      const thumb = btn.closest('.img-thumb');
      thumb.style.transition = 'all .2s';
      thumb.style.opacity = '0';
      thumb.style.transform = 'scale(.8)';
      setTimeout(() => thumb.remove(), 200);
    }
  } catch(e) { console.error(e); }
}

function showConfirm(title, body) {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:400;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(2px);';
    overlay.innerHTML = '<div style="background:white;border-radius:16px;max-width:400px;width:100%;box-shadow:0 24px 72px rgba(0,0,0,.25);overflow:hidden;">'
      + '<div style="background:#fff5f5;padding:20px 24px;display:flex;align-items:center;gap:12px;">'
      + '<div style="width:40px;height:40px;border-radius:10px;background:#fee2e2;display:flex;align-items:center;justify-content:center;font-size:18px;">üóë</div>'
      + '<div style="font-size:15px;font-weight:700;color:#991b1b;">' + title + '</div></div>'
      + '<div style="padding:16px 24px 20px;font-size:13px;color:#64748b;">' + body + '</div>'
      + '<div style="padding:0 24px 20px;display:flex;gap:8px;justify-content:flex-end;">'
      + '<button id="_no_btn" style="padding:9px 18px;border-radius:8px;border:1.5px solid #e2e8f8;background:white;font-weight:600;font-size:12px;cursor:pointer;color:#64748b;font-family:DM Sans,sans-serif;">Annuler</button>'
      + '<button id="_yes_btn" style="padding:9px 18px;border-radius:8px;border:none;background:#ef4444;color:white;font-weight:600;font-size:12px;cursor:pointer;font-family:DM Sans,sans-serif;">üóë Supprimer</button>'
      + '</div></div>';
    document.body.appendChild(overlay);
    overlay.querySelector('#_yes_btn').onclick = () => { document.body.removeChild(overlay); resolve(true); };
    overlay.querySelector('#_no_btn').onclick  = () => { document.body.removeChild(overlay); resolve(false); };
    overlay.onclick = e => { if (e.target === overlay) { document.body.removeChild(overlay); resolve(false); } };
  });
}
</script>
{% endblock %}