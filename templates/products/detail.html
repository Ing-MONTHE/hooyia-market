{% extends 'base.html' %}
{% load static %}

{% block title %}{{ produit.nom }} — HooYia Market{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <!-- Breadcrumb -->
  <nav class="flex items-center gap-2 text-xs font-body text-ink/40 mb-6">
    <a href="/" class="hover:text-brand-600 transition-colors">Accueil</a>
    <span>/</span>
    <a href="/produits/" class="hover:text-brand-600 transition-colors">Catalogue</a>
    <span>/</span>
    <span class="text-ink/70">{{ produit.nom }}</span>
  </nav>

  <!-- Skeleton -->
  <div id="skeleton-detail" class="grid lg:grid-cols-2 gap-12 animate-pulse">
    <div class="bg-cream-warm rounded-2xl h-96"></div>
    <div class="space-y-4">
      <div class="h-4 bg-cream-warm rounded w-1/3"></div>
      <div class="h-8 bg-cream-warm rounded w-3/4"></div>
      <div class="h-4 bg-cream-warm rounded w-1/2"></div>
      <div class="h-16 bg-cream-warm rounded"></div>
      <div class="h-12 bg-cream-warm rounded"></div>
    </div>
  </div>

  <!-- Contenu réel -->
  <div id="product-detail" class="hidden">
    <div class="grid lg:grid-cols-2 gap-12">

      <!-- ── GALERIE ── -->
      <div>
        <div class="relative bg-cream-warm rounded-2xl overflow-hidden mb-3 aspect-square">
          <img id="main-image" src="" alt="{{ produit.nom }}"
            class="w-full h-full object-contain p-4 transition-opacity duration-200"
            onerror="this.src='/static/img/logo.svg'" />
          <span id="promo-badge" class="hidden absolute top-4 left-4 bg-brand-500 text-white text-sm font-mono font-bold px-3 py-1 rounded-xl"></span>
          {% if user.is_staff %}
          <div class="absolute top-4 right-4">
            <a id="edit-link" href="#" class="bg-white/90 text-ink text-xs font-body font-medium px-3 py-1.5 rounded-lg shadow hover:bg-white transition-colors">
              ✏️ Modifier
            </a>
          </div>
          {% endif %}
        </div>
        <div id="thumbnails" class="flex gap-2 overflow-x-auto pb-1"></div>
      </div>

      <!-- ── INFOS PRODUIT ── -->
      <div class="flex flex-col">
        <p id="cat-nom" class="text-xs font-body text-ink/40 uppercase tracking-wider mb-2"></p>
        <h1 id="prod-nom" class="font-display text-3xl text-ink leading-tight mb-3">{{ produit.nom }}</h1>

        <div class="flex items-center gap-2 mb-4">
          <div id="stars" class="text-amber-400 text-lg"></div>
          <span id="nb-avis" class="text-sm text-ink/40 font-body"></span>
        </div>

        <div class="flex items-baseline gap-3 mb-6">
          <span id="prix-actuel" class="font-display text-4xl font-bold text-ink"></span>
          <span id="prix-barre" class="hidden text-xl text-ink/30 line-through font-body"></span>
        </div>

        <p id="desc-courte" class="text-ink/60 font-body text-sm leading-relaxed mb-6"></p>
        <div id="stock-info" class="flex items-center gap-2 mb-6 text-sm font-body"></div>

        <div class="flex items-center gap-3 mb-4">
          {% if not user.is_staff and not user.is_admin and not user.is_vendeur %}
          <div class="flex items-center border border-cream-border rounded-xl overflow-hidden">
            <button onclick="changeQty(-1)" class="px-4 py-3 text-ink/60 hover:bg-cream-warm transition-colors font-body text-lg leading-none">−</button>
            <input type="number" id="qty" value="1" min="1" class="w-14 text-center border-none outline-none font-body text-sm bg-white py-3" />
            <button onclick="changeQty(1)" class="px-4 py-3 text-ink/60 hover:bg-cream-warm transition-colors font-body text-lg leading-none">+</button>
          </div>
          <button onclick="ajouterAuPanier()" id="btn-panier" class="btn-primary flex-1 py-3 text-base">
            Ajouter au panier
          </button>
          {% endif %}
        </div>

        <!-- ── Bouton Contacter le vendeur ── -->
        {% if user.is_authenticated and not user.is_staff and not user.is_admin and not user.is_vendeur %}
        {% if admin_id %}
        <button onclick="contacterVendeur()" id="btn-contact"
          class="w-full mt-2 flex items-center justify-center gap-2 py-3 px-4 rounded-xl border border-brand-300 text-brand-600 font-body font-medium text-sm hover:bg-brand-50 transition-colors">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
          </svg>
          Contacter le vendeur
        </button>
        {% endif %}
        {% endif %}

        <div class="mt-6 pt-6 border-t border-cream-border">
          <h3 class="font-display text-lg text-ink mb-3">Description</h3>
          <div id="description" class="text-ink/60 font-body text-sm leading-relaxed"></div>
        </div>
      </div>
    </div>

    <!-- ── AVIS ── -->
    <section class="mt-16 pt-10 border-t border-cream-border">
      <div class="flex items-center justify-between mb-6">
        <h2 class="font-display text-2xl text-ink">Avis clients</h2>
        {% if user.is_authenticated and not user.is_staff and not user.is_admin and not user.is_vendeur %}
        <button onclick="toggleAvisForm()" class="btn-secondary py-2 px-4 text-sm">Laisser un avis</button>
        {% endif %}
      </div>

      {% if user.is_authenticated and not user.is_staff and not user.is_admin and not user.is_vendeur %}
      <div id="avis-form" class="hidden card p-6 mb-6">
        <h3 class="font-body font-semibold text-ink mb-4">Votre avis</h3>
        <div class="flex gap-2 mb-4" id="star-rating">
          {% for i in "12345" %}
          <button type="button" data-note="{{ forloop.counter }}" onclick="setNote({{ forloop.counter }})"
            class="star-btn text-3xl text-cream-border hover:text-amber-400 transition-colors">★</button>
          {% endfor %}
        </div>
        <textarea id="avis-commentaire" rows="3" placeholder="Partagez votre expérience…" class="field text-sm mb-4"></textarea>
        <button onclick="soumettreAvis()" class="btn-primary py-2 px-6 text-sm">Publier l'avis</button>
      </div>
      {% endif %}

      <div id="avis-list" class="space-y-4">
        <p class="text-ink/30 font-body text-sm">Chargement des avis…</p>
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/products.js' %}"></script>
<script>
// ── Variables Django transmises au JS
const SLUG = '{{ produit.slug }}';
const ADMIN_ID = {% if admin_id %}{{ admin_id }}{% else %}null{% endif %};
let produitData = null;
let noteSelectionnee = 0;
let maxStock = 999;

// ── Chargement du produit
async function loadProduit() {
  try {
    // 1. Cherche par slug exact (filtre dédié)
    let p = null;
    const bySlug = await API.get(`/api/produits/?slug=${encodeURIComponent(SLUG)}`, { silentError: true });
    const slugResults = bySlug?.results ?? bySlug;
    if (Array.isArray(slugResults) && slugResults.length > 0) {
      p = slugResults[0];
    }
    // 2. Fallback: recherche textuelle dans le nom/slug
    if (!p) {
      const bySearch = await API.get(`/api/produits/?search=${encodeURIComponent(SLUG)}`, { silentError: true });
      const searchResults = bySearch?.results ?? bySearch;
      if (Array.isArray(searchResults)) {
        p = searchResults.find(x => x.slug === SLUG);
      }
    }
    if (!p) throw new Error('not found');

    // 3. Charge le détail complet via l'ID
    const detail = await API.get(`/api/produits/${p.id}/`);
    if (!detail || detail.detail) throw new Error('not found');
    produitData = detail;
    maxStock = detail.stock;
    afficherProduit(detail);
    loadAvis(detail.id);
  } catch(e) {
    document.getElementById('skeleton-detail').innerHTML = `
      <div class="col-span-2 text-center py-20">
        <p class="font-display text-xl text-ink/30">Produit introuvable</p>
        <a href="/produits/" class="text-brand-600 text-sm font-body mt-2 inline-block">← Retour au catalogue</a>
      </div>`;
  }
}

function afficherProduit(p) {
  document.getElementById('skeleton-detail').classList.add('hidden');
  document.getElementById('product-detail').classList.remove('hidden');

  const imgs = p.images || [];
  document.getElementById('main-image').src = imgs.length ? imgs[0].image : '/static/img/logo.svg';

  // Miniatures
  const thumbs = document.getElementById('thumbnails');
  if (imgs.length > 1) {
    thumbs.innerHTML = imgs.map((img, i) => `
      <button onclick="setImage('${img.image}')"
        class="flex-shrink-0 w-16 h-16 rounded-xl overflow-hidden border-2 ${i===0?'border-brand-500':'border-cream-border'} hover:border-brand-400 transition-colors">
        <img src="${img.image}" class="w-full h-full object-cover" onerror="this.src='/static/img/logo.svg'" />
      </button>`).join('');
  }

  document.getElementById('cat-nom').textContent    = p.categorie_nom || '';
  document.getElementById('prod-nom').textContent   = p.nom;
  document.getElementById('desc-courte').textContent = p.description_courte || '';
  document.getElementById('description').textContent = p.description || '';

  const prix = p.prix_promo || p.prix;
  document.getElementById('prix-actuel').textContent = formatPrix(prix) + ' CFA';
  if (p.prix_promo) {
    document.getElementById('prix-barre').textContent = formatPrix(p.prix) + ' CFA';
    document.getElementById('prix-barre').classList.remove('hidden');
    document.getElementById('promo-badge').textContent = `-${p.pourcentage_remise}%`;
    document.getElementById('promo-badge').classList.remove('hidden');
  }

  const note = Math.round(parseFloat(p.note_moyenne) || 0);
  document.getElementById('stars').textContent   = '★'.repeat(note) + '☆'.repeat(5 - note);
  document.getElementById('nb-avis').textContent = `${p.nombre_avis} avis`;

  const stockEl = document.getElementById('stock-info');
  if (p.stock > 0) {
    stockEl.innerHTML = `<span class="text-green-600">✓</span><span class="text-green-600 font-medium">En stock</span><span class="text-ink/30">(${p.stock} dispo)</span>`;
  } else {
    stockEl.innerHTML = `<span class="text-red-400 font-medium">Épuisé</span>`;
    const btnPanier = document.getElementById('btn-panier');
    if (btnPanier) {
      btnPanier.disabled = true;
      btnPanier.classList.add('opacity-50', 'cursor-not-allowed');
    }
  }

  const editLink = document.getElementById('edit-link');
  if (editLink) editLink.href = `/produits/modifier/${p.id}/`;
}

function setImage(src) {
  const img = document.getElementById('main-image');
  img.style.opacity = '0.5';
  setTimeout(() => { img.src = src; img.style.opacity = '1'; }, 150);
}

function changeQty(delta) {
  const input = document.getElementById('qty');
  input.value = Math.max(1, Math.min(maxStock, parseInt(input.value) + delta));
}

async function ajouterAuPanier() {
  if (!produitData) return;
  try {
    await API.post('/api/panier/ajouter/', { produit_id: produitData.id, quantite: parseInt(document.getElementById('qty').value) });
    window.toast && window.toast('Produit ajouté au panier !', 'success');
    const badge = document.getElementById('cart-badge');
    if (badge) { badge.classList.remove('hidden'); badge.textContent = (parseInt(badge.textContent) || 0) + 1; }
  } catch(e) {}
}

// ── Avis
async function loadAvis(produitId) {
  try {
    const data = await API.get(`/api/avis/?produit=${produitId}`, { silentError: true });
    const avis = data.results || data;
    const container = document.getElementById('avis-list');
    if (!avis.length) { container.innerHTML = `<p class="text-ink/30 font-body text-sm">Aucun avis pour le moment.</p>`; return; }
    container.innerHTML = avis.map(a => {
      const nom = a.auteur_nom || a.nom_utilisateur || 'Anonyme';
      const initiale = nom[0].toUpperCase();
      const avatar = a.auteur_photo
        ? `<img src="${a.auteur_photo}" alt="${nom}" class="h-9 w-9 rounded-full object-cover border border-cream-border">`
        : `<span class="h-9 w-9 rounded-full bg-brand-100 flex items-center justify-center text-sm font-semibold text-brand-600">${initiale}</span>`;
      const date = a.date_creation ? new Date(a.date_creation).toLocaleDateString('fr-FR', {day:'numeric',month:'long',year:'numeric'}) : '';
      return `
      <div class="card p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            ${avatar}
            <div>
              <span class="font-body font-semibold text-sm text-ink">${nom}</span>
              ${date ? `<p class="text-xs text-ink/40 font-body mt-0.5">${date}</p>` : ''}
            </div>
          </div>
          <span class="text-amber-400 text-base">${'★'.repeat(a.note)}${'☆'.repeat(5-a.note)}</span>
        </div>
        <p class="text-ink/60 font-body text-sm leading-relaxed">${a.commentaire || ''}</p>
      </div>`;
    }).join('');
  } catch(e) {}
}

function toggleAvisForm() { document.getElementById('avis-form').classList.toggle('hidden'); }

function setNote(n) {
  noteSelectionnee = n;
  document.querySelectorAll('.star-btn').forEach((btn, i) => {
    btn.className = 'star-btn text-3xl transition-colors ' + (i < n ? 'text-amber-400' : 'text-cream-border hover:text-amber-400');
  });
}

async function soumettreAvis() {
  if (!noteSelectionnee) {
    window.toast && window.toast('Veuillez sélectionner une note (1 à 5 étoiles).', 'error');
    return;
  }
  if (!produitData) return;
  try {
    await API.post('/api/avis/', {
      produit: produitData.id,
      note: noteSelectionnee,
      commentaire: document.getElementById('avis-commentaire').value
    }, { silentError: true });
    window.toast && window.toast('Avis soumis, en attente de validation.', 'success');
    toggleAvisForm();
    // Recharge les avis pour refléter le nouvel avis
    chargerAvis();
  } catch(e) {
    // API.js enrichit l'erreur avec .message (déjà extrait via extractErrorMessage)
    const msg = (e && e.message) ? e.message : 'Une erreur est survenue.';
    window.toast && window.toast(msg, 'error');
  }
}

async function contacterVendeur() {
  if (!ADMIN_ID) return;
  const btn = document.getElementById('btn-contact');
  if (btn) { btn.disabled = true; btn.textContent = 'Connexion…'; }
  try {
    const conv = await API.post('/api/chat/creer/', { utilisateur_id: ADMIN_ID }, { silentError: true });
    window.location.href = '/chat/' + conv.id + '/';
  } catch(e) {
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'Contacter le vendeur';
    }
    const msg = (e && e.message) ? e.message : 'Impossible d\u2019ouvrir la conversation.';
    window.toast && window.toast(msg, 'error');
  }
}

loadProduit();
</script>
{% endblock %}