{% extends 'base.html' %}
{% load static %}

{% block title %}Mon Profil ‚Äî HooYia Market{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

  {% if user.is_staff %}
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       VUE ADMINISTRATEUR
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <div class="flex items-center gap-4 mb-8">
    <div class="h-16 w-16 rounded-2xl bg-brand-600 flex items-center justify-center text-2xl font-bold text-white flex-shrink-0">
      {{ user.prenom|first|upper }}{{ user.nom|first|upper }}
    </div>
    <div>
      <div class="flex items-center gap-2">
        <h1 class="font-display text-2xl text-ink">{{ user.get_full_name }}</h1>
        <span class="px-2.5 py-0.5 rounded-full bg-brand-100 text-brand-700 text-xs font-body font-semibold">Administrateur</span>
      </div>
      <p class="text-ink/50 font-body text-sm">{{ user.email }}</p>
    </div>
  </div>

  <div class="grid lg:grid-cols-3 gap-6">

    <!-- ‚îÄ‚îÄ COLONNE GAUCHE : Infos + Stats ‚îÄ‚îÄ -->
    <div class="space-y-5">

      <!-- Informations personnelles -->
      <div class="card p-5">
        <h2 class="font-display text-base text-ink mb-4">Informations</h2>
        <form method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_profil" />
          <div class="space-y-3">
            <div>
              <label class="label text-xs">Pr√©nom</label>
              <input type="text" name="prenom" value="{{ user.prenom }}" class="field text-sm" />
            </div>
            <div>
              <label class="label text-xs">Nom</label>
              <input type="text" name="nom" value="{{ user.nom }}" class="field text-sm" />
            </div>
            <div>
              <label class="label text-xs">T√©l√©phone</label>
              <input type="text" name="telephone" value="{{ user.telephone }}" class="field text-sm" />
            </div>
          </div>
          <button type="submit" class="btn-primary w-full py-2 text-sm mt-4">Mettre √† jour</button>
        </form>
      </div>

      <!-- Acc√®s rapides admin -->
      <div class="card p-5">
        <h2 class="font-display text-base text-ink mb-4">Acc√®s rapides</h2>
        <div class="space-y-2">
          <a href="/admin/" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-cream-warm transition-colors text-sm font-body text-ink/70">
            <span class="text-lg">‚öôÔ∏è</span> Interface d'administration
          </a>
          <a href="{% url 'products:ajouter' %}" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-cream-warm transition-colors text-sm font-body text-ink/70">
            <span class="text-lg">‚ûï</span> Ajouter un produit
          </a>
          <a href="{% url 'products:liste' %}" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-cream-warm transition-colors text-sm font-body text-ink/70">
            <span class="text-lg">üì¶</span> G√©rer le catalogue
          </a>
          <a href="{% url 'orders:historique' %}" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-cream-warm transition-colors text-sm font-body text-ink/70">
            <span class="text-lg">üìã</span> Toutes les commandes
          </a>
          <a href="/chat/" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-cream-warm transition-colors text-sm font-body text-ink/70">
            <span class="text-lg">üí¨</span> Messages clients
          </a>
        </div>
      </div>

    </div>

    <!-- ‚îÄ‚îÄ COLONNE DROITE : Stats + Tableau de bord ‚îÄ‚îÄ -->
    <div class="lg:col-span-2 space-y-5">

      <!-- Stats KPI -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="card p-4 text-center" id="kpi-produits">
          <p class="font-display text-2xl text-brand-600" id="nb-produits">‚Äî</p>
          <p class="text-xs font-body text-ink/40 mt-1">Produits</p>
        </div>
        <div class="card p-4 text-center">
          <p class="font-display text-2xl text-ink" id="nb-commandes">‚Äî</p>
          <p class="text-xs font-body text-ink/40 mt-1">Commandes</p>
        </div>
        <div class="card p-4 text-center">
          <p class="font-display text-2xl text-ink" id="nb-utilisateurs">‚Äî</p>
          <p class="text-xs font-body text-ink/40 mt-1">Utilisateurs</p>
        </div>
        <div class="card p-4 text-center">
          <p class="font-display text-2xl text-ink" id="nb-avis">‚Äî</p>
          <p class="text-xs font-body text-ink/40 mt-1">Avis</p>
        </div>
      </div>

      <!-- Derni√®res commandes -->
      <div class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-display text-base text-ink">Derni√®res commandes</h2>
          <a href="{% url 'orders:historique' %}" class="text-xs text-brand-600 font-body hover:underline">Voir tout ‚Üí</a>
        </div>
        <div id="derni√®res-commandes">
          <p class="text-ink/30 font-body text-sm animate-pulse">Chargement‚Ä¶</p>
        </div>
      </div>

      <!-- Produits stock faible -->
      <div class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-display text-base text-ink">‚ö† Stock faible</h2>
          <a href="{% url 'products:liste' %}" class="text-xs text-brand-600 font-body hover:underline">Voir le catalogue ‚Üí</a>
        </div>
        <div id="stock-faible">
          <p class="text-ink/30 font-body text-sm animate-pulse">Chargement‚Ä¶</p>
        </div>
      </div>

    </div>
  </div>

  {% else %}
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       VUE UTILISATEUR NORMAL
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <div class="grid lg:grid-cols-3 gap-8">

    <!-- ‚îÄ‚îÄ COLONNE GAUCHE : Avatar + Infos ‚îÄ‚îÄ -->
    <div class="space-y-5">

      <!-- Avatar + nom -->
      <div class="card p-6 text-center">
        <form method="POST" enctype="multipart/form-data" id="photo-form">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_profil" />
          <div class="relative inline-block mb-4">
            {% if user.photo_profil %}
            <img src="{{ user.photo_profil.url }}" alt="Photo de profil"
              class="h-24 w-24 rounded-2xl object-cover mx-auto" />
            {% else %}
            <div class="h-24 w-24 rounded-2xl bg-brand-600 flex items-center justify-center text-3xl font-bold text-white mx-auto">
              {{ user.prenom|first|upper }}{{ user.nom|first|upper }}
            </div>
            {% endif %}
            <button type="button" onclick="document.getElementById('photo-input').click()"
              class="absolute -bottom-1 -right-1 bg-white border border-cream-border rounded-lg p-1.5 shadow hover:bg-cream-warm transition-colors">
              <svg class="h-3.5 w-3.5 text-ink/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </button>
            <input type="file" id="photo-input" name="photo_profil" accept="image/*" class="hidden"
              onchange="document.getElementById('photo-form').submit()" />
          </div>
        </form>

        <h2 class="font-display text-xl text-ink">{{ user.get_full_name }}</h2>
        <p class="text-ink/40 font-body text-sm">{{ user.email }}</p>

        <div class="mt-3 flex justify-center gap-2">
          {% if user.email_verifie %}
          <span class="px-2.5 py-0.5 rounded-full bg-green-100 text-green-700 text-xs font-body">‚úì Email v√©rifi√©</span>
          {% else %}
          <span class="px-2.5 py-0.5 rounded-full bg-red-100 text-red-500 text-xs font-body">Email non v√©rifi√©</span>
          {% endif %}
          {% if user.is_vendeur %}
          <span class="px-2.5 py-0.5 rounded-full bg-amber-100 text-amber-700 text-xs font-body">Vendeur</span>
          {% endif %}
        </div>

        <div class="mt-4 pt-4 border-t border-cream-border text-left">
          <p class="text-xs text-ink/30 font-body">Membre depuis</p>
          <p class="text-sm font-body text-ink">{{ user.date_inscription|date:"d F Y" }}</p>
        </div>
      </div>

      <!-- Navigation rapide -->
      <div class="card p-4">
        <nav class="space-y-1">
          <a href="{% url 'orders:historique' %}" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-cream-warm transition-colors text-sm font-body text-ink/70">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            Mes commandes
          </a>
          <a href="{% url 'cart:panier' %}" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-cream-warm transition-colors text-sm font-body text-ink/70">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
            Mon panier
          </a>
          <a href="/chat/" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-cream-warm transition-colors text-sm font-body text-ink/70">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
            Mes messages
          </a>
          <a href="{% url 'users:deconnexion' %}" class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-red-50 transition-colors text-sm font-body text-red-400">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
            D√©connexion
          </a>
        </nav>
      </div>

    </div>

    <!-- ‚îÄ‚îÄ COLONNE DROITE : Formulaires ‚îÄ‚îÄ -->
    <div class="lg:col-span-2 space-y-6">

      <!-- Infos personnelles -->
      <div class="card p-6">
        <h2 class="font-display text-lg text-ink mb-5 pb-3 border-b border-cream-border">Informations personnelles</h2>

        {% if messages %}
          {% for message in messages %}
          <div class="mb-4 px-4 py-3 rounded-xl border text-sm font-body
            {% if message.tags == 'success' %}bg-green-50 border-green-200 text-green-800{% else %}bg-red-50 border-red-200 text-red-800{% endif %}">
            {{ message }}
          </div>
          {% endfor %}
        {% endif %}

        <form method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_profil" />
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="label" for="id_prenom">Pr√©nom</label>
              <input type="text" name="prenom" id="id_prenom" value="{{ user.prenom }}" class="field" />
            </div>
            <div>
              <label class="label" for="id_nom">Nom</label>
              <input type="text" name="nom" id="id_nom" value="{{ user.nom }}" class="field" />
            </div>
            <div class="col-span-2">
              <label class="label" for="id_username">Nom d'utilisateur</label>
              <input type="text" name="username" id="id_username" value="{{ user.username }}" class="field" />
            </div>
            <div class="col-span-2">
              <label class="label" for="id_telephone">T√©l√©phone</label>
              <input type="text" name="telephone" id="id_telephone" value="{{ user.telephone }}" class="field" />
            </div>
            <div class="col-span-2">
              <label class="label">Email</label>
              <input type="email" value="{{ user.email }}" class="field bg-cream-warm cursor-not-allowed" disabled />
              <p class="text-xs text-ink/30 font-body mt-1">L'email ne peut pas √™tre modifi√©.</p>
            </div>
          </div>
          <button type="submit" class="btn-primary py-2.5 px-6 text-sm mt-5">Enregistrer les modifications</button>
        </form>
      </div>

      <!-- Adresses de livraison -->
      <div class="card p-6">
        <div class="flex items-center justify-between mb-5 pb-3 border-b border-cream-border">
          <h2 class="font-display text-lg text-ink">Adresses de livraison</h2>
          <a href="{% url 'users:ajouter_adresse' %}" class="btn-primary py-1.5 px-4 text-xs">+ Ajouter</a>
        </div>

        {% if adresses %}
        <div class="space-y-3">
          {% for adr in adresses %}
          <div class="flex items-start justify-between gap-4 p-4 rounded-xl border {% if adr.is_default %}border-brand-400 bg-brand-50{% else %}border-cream-border{% endif %}">
            <div>
              {% if adr.is_default %}
              <span class="inline-block mb-1 px-2 py-0.5 rounded-full bg-brand-500 text-white text-[10px] font-body font-semibold">Par d√©faut</span>
              {% endif %}
              <p class="font-body font-medium text-sm text-ink">{{ adr.nom_complet }}</p>
              <p class="text-xs text-ink/50 font-body">{{ adr.adresse }}, {{ adr.ville }}</p>
              <p class="text-xs text-ink/50 font-body">{{ adr.region }}, {{ adr.pays }}</p>
              {% if adr.telephone %}<p class="text-xs text-ink/50 font-body">{{ adr.telephone }}</p>{% endif %}
            </div>
            <form method="POST" onsubmit="return confirm('Supprimer cette adresse ?')">
              {% csrf_token %}
              <button type="submit" formaction="{% url 'users:supprimer_adresse' adr.id %}"
                class="text-xs text-red-400 hover:text-red-600 font-body underline underline-offset-2">
                Supprimer
              </button>
            </form>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
          <p class="text-ink/30 font-body text-sm">Aucune adresse enregistr√©e.</p>
          <a href="{% url 'users:ajouter_adresse' %}" class="text-brand-600 text-sm font-body underline mt-2 inline-block">Ajouter une adresse</a>
        </div>
        {% endif %}
      </div>

      <!-- Commandes r√©centes -->
      <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-display text-lg text-ink">Commandes r√©centes</h2>
          <a href="{% url 'orders:historique' %}" class="text-xs text-brand-600 font-body hover:underline">Voir tout ‚Üí</a>
        </div>
        <div id="commandes-recentes">
          <p class="text-ink/30 font-body text-sm animate-pulse">Chargement‚Ä¶</p>
        </div>
      </div>

    </div>
  </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_scripts %}
<script>
{% if user.is_staff %}
// ‚îÄ‚îÄ Dashboard admin : charger les stats
async function loadAdminStats() {
  try {
    const [produits, commandes, avis] = await Promise.allSettled([
      API.get('/api/produits/?page_size=1', { silentError: true }),
      API.get('/api/commandes/', { silentError: true }),
      API.get('/api/avis/', { silentError: true }),
    ]);

    if (produits.status === 'fulfilled')
      document.getElementById('nb-produits').textContent = produits.value.count || '‚Äî';
    if (commandes.status === 'fulfilled') {
      const cmds = commandes.value.results || commandes.value;
      document.getElementById('nb-commandes').textContent = commandes.value.count || cmds.length || '‚Äî';

      // Derni√®res commandes
      const lastCmds = cmds.slice(0, 5);
      const COLORS = { en_attente:'bg-yellow-100 text-yellow-700', confirmee:'bg-blue-100 text-blue-700', en_preparation:'bg-purple-100 text-purple-700', expediee:'bg-orange-100 text-orange-700', livree:'bg-green-100 text-green-700', annulee:'bg-red-100 text-red-400' };
      const LABELS = { en_attente:'En attente', confirmee:'Confirm√©e', en_preparation:'En pr√©paration', expediee:'Exp√©di√©e', livree:'Livr√©e', annulee:'Annul√©e' };
      document.getElementById('derni√®res-commandes').innerHTML = lastCmds.length
        ? lastCmds.map(c => `
          <div class="flex items-center justify-between py-2 border-b border-cream-border last:border-0">
            <div>
              <a href="/commandes/${c.id}/" class="text-sm font-body font-medium text-ink hover:text-brand-600">#${c.reference || c.id}</a>
              <p class="text-xs text-ink/40 font-body">${new Date(c.date_creation).toLocaleDateString('fr-FR')}</p>
            </div>
            <div class="flex items-center gap-3">
              <span class="text-sm font-body font-semibold text-ink">${parseInt(c.total).toLocaleString('fr-FR')} F</span>
              <span class="px-2 py-0.5 rounded-full text-xs font-body ${COLORS[c.statut]||'bg-gray-100 text-gray-600'}">${LABELS[c.statut]||c.statut}</span>
            </div>
          </div>`).join('')
        : '<p class="text-ink/30 font-body text-sm">Aucune commande.</p>';
    }
    if (avis.status === 'fulfilled')
      document.getElementById('nb-avis').textContent = avis.value.count || '‚Äî';
  } catch(e) {}
}

// Stock faible
async function loadStockFaible() {
  try {
    const data = await API.get('/api/produits/?stock_faible=true', { silentError: true });
    const produits = data.results || data;
    document.getElementById('stock-faible').innerHTML = produits.length
      ? produits.slice(0, 5).map(p => `
        <div class="flex items-center justify-between py-2 border-b border-cream-border last:border-0">
          <a href="/produits/${p.slug}/" class="text-sm font-body text-ink hover:text-brand-600">${p.nom}</a>
          <span class="text-xs font-mono font-bold ${p.stock <= 2 ? 'text-red-500' : 'text-amber-500'}">${p.stock} restant${p.stock > 1 ? 's' : ''}</span>
        </div>`).join('')
      : '<p class="text-ink/30 font-body text-sm">Aucun produit en stock faible. ‚úì</p>';
  } catch(e) {}
}

loadAdminStats();
loadStockFaible();

{% else %}
// ‚îÄ‚îÄ Commandes r√©centes utilisateur
async function loadCommandesRecentes() {
  try {
    const data = await API.get('/api/commandes/', { silentError: true });
    const cmds = (data.results || data).slice(0, 3);
    const COLORS = { en_attente:'bg-yellow-100 text-yellow-700', confirmee:'bg-blue-100 text-blue-700', en_preparation:'bg-purple-100 text-purple-700', expediee:'bg-orange-100 text-orange-700', livree:'bg-green-100 text-green-700', annulee:'bg-red-100 text-red-400' };
    const LABELS = { en_attente:'En attente', confirmee:'Confirm√©e', en_preparation:'En pr√©paration', expediee:'Exp√©di√©e', livree:'Livr√©e', annulee:'Annul√©e' };

    document.getElementById('commandes-recentes').innerHTML = cmds.length
      ? cmds.map(c => `
        <div class="flex items-center justify-between py-2.5 border-b border-cream-border last:border-0">
          <div>
            <a href="/commandes/${c.id}/" class="text-sm font-body font-medium text-ink hover:text-brand-600">Commande #${c.reference || c.id}</a>
            <p class="text-xs text-ink/40 font-body">${new Date(c.date_creation).toLocaleDateString('fr-FR')}</p>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-sm font-body font-semibold">${parseInt(c.total).toLocaleString('fr-FR')} F</span>
            <span class="px-2 py-0.5 rounded-full text-xs font-body ${COLORS[c.statut]||'bg-gray-100'}">${LABELS[c.statut]||c.statut}</span>
          </div>
        </div>`).join('')
      : '<p class="text-ink/30 font-body text-sm">Aucune commande pour le moment.</p>';
  } catch(e) {
    document.getElementById('commandes-recentes').innerHTML = '<p class="text-ink/30 font-body text-sm">Impossible de charger les commandes.</p>';
  }
}

loadCommandesRecentes();
{% endif %}
</script>
{% endblock %}