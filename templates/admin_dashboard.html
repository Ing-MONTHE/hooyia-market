{% extends 'base.html' %}
{% load static %}

{% block title %}Administration â€” HooYia Market{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLES & RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:     #0D1F5C;
  --blue:     #1E3A8A;
  --blue-l:   #2d52c4;
  --orange:   #F97316;
  --orange-d: #ea6000;
  --green:    #10b981;
  --red:      #ef4444;
  --yellow:   #f59e0b;
  --bg:       #f0f3fa;
  --sidebar:  240px;
  --card-r:   12px;
  --border:   #e2e8f8;
  --shadow:   0 1px 4px rgba(13,31,92,.07);
  --shadow-h: 0 6px 24px rgba(13,31,92,.13);
}
body { background: var(--bg) !important; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.da-root { display: flex; min-height: calc(100vh - 104px); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.da-sidebar {
  width: var(--sidebar); flex-shrink: 0;
  background: var(--navy);
  position: relative;
  min-height: calc(100vh - 104px);
  display: flex; flex-direction: column;
  overflow-y: auto; overflow-x: hidden;
}
/* scrollbar sidebar */
.da-sidebar::-webkit-scrollbar { width: 3px; }
.da-sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,.15); }

.da-sb-head {
  padding: 18px 16px; border-bottom: 1px solid rgba(255,255,255,.07);
  display: flex; align-items: center; gap: 10px; flex-shrink: 0;
}
.da-sb-avatar {
  width: 40px; height: 40px; border-radius: 10px; flex-shrink: 0;
  background: linear-gradient(135deg, var(--orange), var(--orange-d));
  display: flex; align-items: center; justify-content: center;
  font-family: 'Syne', sans-serif; font-weight: 800; font-size: 15px; color: white;
}
.da-sb-name { font-size: 13px; font-weight: 600; color: white; line-height: 1.2; }
.da-sb-role { font-size: 11px; color: rgba(255,255,255,.35); }

.da-sb-group { padding: 6px 0; }
.da-sb-lbl {
  font-size: 9.5px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
  color: rgba(255,255,255,.28); padding: 10px 16px 3px;
}
.da-sb-item {
  display: flex; align-items: center; gap: 9px;
  padding: 8px 16px; font-size: 12.5px; font-weight: 500;
  color: rgba(255,255,255,.58); text-decoration: none;
  border-left: 3px solid transparent; cursor: pointer;
  background: transparent; border-top: none; border-right: none; border-bottom: none;
  width: 100%; text-align: left; font-family: 'DM Sans', sans-serif;
  transition: color .12s, background .12s, border-color .12s;
}
.da-sb-item:hover { color: rgba(255,255,255,.9); background: rgba(255,255,255,.05); border-left-color: rgba(255,255,255,.15); }
.da-sb-item.active { color: white; background: rgba(249,115,22,.18); border-left-color: var(--orange); font-weight: 600; }
.da-sb-item .ic { width: 17px; text-align: center; font-size: 14px; }
.da-sb-chip {
  margin-left: auto; min-width: 18px; height: 18px; padding: 0 4px;
  background: var(--orange); color: white; font-size: 9.5px; font-weight: 700;
  border-radius: 50px; display: flex; align-items: center; justify-content: center;
  font-family: 'DM Mono', monospace;
}
.da-sb-chip.blue { background: var(--blue-l); }
.da-sb-divider { border: none; border-top: 1px solid rgba(255,255,255,.06); margin: 2px 0; }

.da-sb-footer {
  margin-top: auto; padding: 12px 16px; border-top: 1px solid rgba(255,255,255,.07); flex-shrink: 0;
}
.da-sb-footer a {
  display: flex; align-items: center; gap: 8px;
  font-size: 12px; color: rgba(255,255,255,.45); text-decoration: none;
  padding: 6px 0; transition: color .15s;
}
.da-sb-footer a:hover { color: rgba(255,255,255,.8); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.da-main { flex: 1; min-width: 0; padding: 28px 30px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.da-ph { display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 24px; }
.da-ph h1 {
  font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800;
  color: var(--navy); letter-spacing: -.4px; margin: 0; line-height: 1;
}
.da-ph-sub { font-size: 12px; color: #94a3b8; margin-top: 5px; font-family: 'DM Mono', monospace; }
.da-btn-primary {
  display: inline-flex; align-items: center; gap: 7px;
  padding: 8px 16px; background: var(--orange); color: white;
  font-size: 12.5px; font-weight: 700; border-radius: 8px;
  text-decoration: none; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif;
  transition: background .15s, box-shadow .15s;
}
.da-btn-primary:hover { background: var(--orange-d); box-shadow: 0 4px 14px rgba(249,115,22,.35); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KPI GRID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.da-kpi-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 14px; margin-bottom: 20px; }
.da-kpi {
  background: white; border-radius: var(--card-r); padding: 18px 20px;
  box-shadow: var(--shadow); border: 1px solid var(--border);
  position: relative; overflow: hidden; transition: box-shadow .2s, transform .15s;
}
.da-kpi:hover { box-shadow: var(--shadow-h); transform: translateY(-1px); }
.da-kpi-accent {
  position: absolute; top: 0; left: 0; right: 0; height: 3px; border-radius: var(--card-r) var(--card-r) 0 0;
}
.da-kpi-icon {
  width: 40px; height: 40px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; margin-bottom: 12px;
}
.da-kpi-val {
  font-family: 'Syne', sans-serif; font-size: 30px; font-weight: 800;
  color: var(--navy); line-height: 1;
}
.da-kpi-lbl { font-size: 12px; color: #94a3b8; margin-top: 3px; font-weight: 500; }
.da-kpi-trend { display: flex; align-items: center; gap: 4px; font-size: 11px; margin-top: 8px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.da-card {
  background: white; border-radius: var(--card-r);
  box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden;
}
.da-card-hd {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 18px; border-bottom: 1px solid #f1f5fd;
}
.da-card-hd h3 {
  font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700;
  color: var(--navy); margin: 0;
}
.da-card-hd a, .da-card-hd button.link {
  font-size: 12px; color: var(--blue-l); text-decoration: none; font-weight: 600;
  background: none; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif;
}
.da-card-hd a:hover, .da-card-hd button.link:hover { color: var(--orange); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.da-table { width: 100%; border-collapse: collapse; }
.da-table th {
  font-size: 10.5px; font-weight: 700; letter-spacing: .8px; text-transform: uppercase;
  color: #94a3b8; padding: 9px 16px; text-align: left; background: #f8faff; white-space: nowrap;
}
.da-table td {
  padding: 11px 16px; font-size: 13px; color: #334155;
  border-top: 1px solid #f1f5fd; vertical-align: middle;
}
.da-table tr:hover td { background: #fafbff; }
.da-table .mono { font-family: 'DM Mono', monospace; font-size: 11.5px; color: #64748b; }
.da-table .bold { font-weight: 600; color: var(--navy); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATUS BADGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.st {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 2px 9px; border-radius: 50px; font-size: 10.5px; font-weight: 700; white-space: nowrap;
}
.st::before { content: ''; width: 5px; height: 5px; border-radius: 50%; }
.st-wait   { background: #fef3c7; color: #92400e; }        .st-wait::before   { background: #f59e0b; }
.st-conf   { background: #dbeafe; color: #1e40af; }        .st-conf::before   { background: #3b82f6; }
.st-prep   { background: #ede9fe; color: #5b21b6; }        .st-prep::before   { background: #8b5cf6; }
.st-ship   { background: #cffafe; color: #164e63; }        .st-ship::before   { background: #06b6d4; }
.st-done   { background: #dcfce7; color: #14532d; }        .st-done::before   { background: #16a34a; }
.st-cancel { background: #fee2e2; color: #7f1d1d; }        .st-cancel::before { background: #dc2626; }
.st-active { background: #dcfce7; color: #14532d; }        .st-active::before { background: #16a34a; }
.st-off    { background: #f1f5f9; color: #475569; }        .st-off::before    { background: #94a3b8; }
.st-valid  { background: #dcfce7; color: #14532d; }        .st-valid::before  { background: #16a34a; }
.st-pend   { background: #fef3c7; color: #92400e; }        .st-pend::before   { background: #f59e0b; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT GRIDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.da-row { display: grid; gap: 16px; margin-bottom: 16px; }
.da-row-3-1 { grid-template-columns: 3fr 1.2fr; }
.da-row-2   { grid-template-columns: 1fr 1fr; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUICK ACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.qa-list { padding: 14px; display: flex; flex-direction: column; gap: 7px; }
.qa {
  display: flex; align-items: center; gap: 11px;
  padding: 10px 12px; border-radius: 9px; font-size: 12.5px; font-weight: 600;
  text-decoration: none; border: 1px solid transparent;
  font-family: 'DM Sans', sans-serif; transition: all .13s; cursor: pointer;
}
.qa-ico { width: 30px; height: 30px; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
.qa.or { background: var(--orange); color: white; }
.qa.or:hover { background: var(--orange-d); box-shadow: 0 3px 12px rgba(249,115,22,.3); }
.qa.or .qa-ico { background: rgba(255,255,255,.22); }
.qa.bl { background: #eff4ff; color: var(--blue); border-color: #dce7fd; }
.qa.bl:hover { background: #dce7fd; }
.qa.bl .qa-ico { background: #dce7fd; }
.qa.gr { background: #ecfdf5; color: #065f46; border-color: #a7f3d0; }
.qa.gr:hover { background: #d1fae5; }
.qa.gr .qa-ico { background: #a7f3d0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOCK BARS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sk-row { display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-top: 1px solid #f1f5fd; }
.sk-bar-bg { flex: 1; height: 5px; background: #f1f5f9; border-radius: 99px; overflow: hidden; }
.view-toggle { display:flex; gap:4px; }
.vt-btn { padding:5px 8px; border-radius:6px; border:1.5px solid var(--border); background:white; cursor:pointer; color:#94a3b8; transition:.15s; font-size:14px; }
.vt-btn.active { border-color:var(--blue); background:var(--blue); color:white; }
.st-filter-btn { padding:6px 14px; border-radius:20px; border:1.5px solid var(--border); background:white; cursor:pointer; font-size:12px; font-weight:600; color:#64748b; transition:.15s; font-family:'DM Sans',sans-serif; }
.st-filter-btn:hover { border-color:var(--blue); color:var(--blue); }
.st-filter-btn.active { border-color:var(--blue); background:var(--blue); color:white; }
.card-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:14px; padding:16px; }
.prod-card { border:1px solid var(--border); border-radius:10px; overflow:hidden; background:white; transition:box-shadow .15s; }
.prod-card:hover { box-shadow:0 4px 16px rgba(0,0,0,.1); }
.prod-card-img { width:100%; aspect-ratio:1; object-fit:cover; background:#f8fafc; }
.prod-card-body { padding:10px; }
.prod-card-name { font-size:12.5px; font-weight:700; color:var(--navy); line-height:1.3; margin-bottom:4px; }
.prod-card-meta { font-size:11px; color:#94a3b8; margin-bottom:6px; }
.prod-card-price { font-size:13px; font-weight:700; color:var(--blue); font-family:monospace; }
.cat-card { border:1px solid var(--border); border-radius:10px; overflow:hidden; background:white; transition:box-shadow .15s; }
.cat-card:hover { box-shadow:0 4px 16px rgba(0,0,0,.1); }
.cat-card-img { width:100%; aspect-ratio:1; object-fit:cover; background:#f8fafc; display:flex; align-items:center; justify-content:center; font-size:32px; }
.cat-card-body { padding:10px; }
.cat-card-name { font-size:13px; font-weight:700; color:var(--navy); }
.cat-card-meta { font-size:11px; color:#94a3b8; margin-top:3px; }
.sk-bar { height: 100%; border-radius: 99px; transition: width .4s ease; }
.sk-ok  { background: var(--green); }
.sk-lo  { background: var(--orange); }
.sk-cr  { background: var(--red); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTIVITY FEED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.af-item { display: flex; gap: 12px; padding: 11px 16px; border-top: 1px solid #f1f5fd; }
.af-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 5px; }
.af-text { font-size: 12.5px; color: #334155; line-height: 1.5; }
.af-time { font-size: 10.5px; color: #94a3b8; font-family: 'DM Mono', monospace; margin-top: 1px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MINI STATS ROW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.da-mini { display: grid; grid-template-columns: repeat(3,1fr); }
.da-mini-cell { padding: 16px; text-align: center; border-right: 1px solid #f1f5fd; }
.da-mini-cell:last-child { border-right: none; }
.da-mini-val { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 800; color: var(--navy); }
.da-mini-lbl { font-size: 11px; color: #94a3b8; margin-top: 2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY / LOADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.da-empty { text-align: center; padding: 28px; color: #94a3b8; font-size: 13px; }
.da-loading { text-align: center; padding: 20px; color: #94a3b8; font-size: 12px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION VISIBILITY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.da-section { display: none; }
.da-section.shown { display: block; animation: da-in .25s ease both; }
@keyframes da-in { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.da-kpi { animation: da-in .3s ease both; }
.da-kpi:nth-child(1) { animation-delay: .04s; }
.da-kpi:nth-child(2) { animation-delay: .08s; }
.da-kpi:nth-child(3) { animation-delay: .12s; }
.da-kpi:nth-child(4) { animation-delay: .16s; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 1100px) { .da-kpi-grid { grid-template-columns: repeat(2,1fr); } }
@media (max-width: 960px)  { .da-row-3-1, .da-row-2 { grid-template-columns: 1fr; } }
@media (max-width: 800px)  { .da-sidebar { display: none; } }
@media (max-width: 540px)  { .da-kpi-grid { grid-template-columns: 1fr; } .da-main { padding: 16px; } }
</style>
{% endblock %}

{% block content %}
<div class="da-root">

  <!-- â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â• -->
  <aside class="da-sidebar">
    <div class="da-sb-head">
      <div class="da-sb-avatar">{{ user.prenom|first|default:"A"|upper }}{{ user.nom|first|default:""|upper }}</div>
      <div>
        <div class="da-sb-name">{{ user.get_full_name|default:user.username }}</div>
        <div class="da-sb-role">Administrateur</div>
      </div>
    </div>

    <div class="da-sb-group">
      <div class="da-sb-lbl">Vue d'ensemble</div>
      <button class="da-sb-item active" data-section="overview" onclick="nav(this)">
        <span class="ic">ğŸ“Š</span> Dashboard
      </button>
    </div>

    <hr class="da-sb-divider"/>

    <div class="da-sb-group">
      <div class="da-sb-lbl">Catalogue</div>
      <button class="da-sb-item" data-section="produits" onclick="nav(this)">
        <span class="ic">ğŸ“¦</span> Produits
      </button>
      <button class="da-sb-item" data-section="categories" onclick="nav(this)">
        <span class="ic">ğŸ·ï¸</span> CatÃ©gories
      </button>
      <button class="da-sb-item" data-section="stocks" onclick="nav(this)">
        <span class="ic">âš ï¸</span> Stocks
        <span class="da-sb-chip" id="chip-stocks" style="display:none;">!</span>
      </button>
    </div>

    <hr class="da-sb-divider"/>

    <div class="da-sb-group">
      <div class="da-sb-lbl">Commerce</div>
      <button class="da-sb-item" data-section="commandes" onclick="nav(this)">
        <span class="ic">ğŸ›’</span> Commandes
        <span class="da-sb-chip" id="chip-commandes" style="display:none;"></span>
      </button>
      <button class="da-sb-item" data-section="avis" onclick="nav(this)">
        <span class="ic">â­</span> Avis
        <span class="da-sb-chip blue" id="chip-avis" style="display:none;"></span>
      </button>
      <button class="da-sb-item" data-section="paniers" onclick="nav(this)">
        <span class="ic">ğŸ›ï¸</span> Paniers actifs
      </button>
    </div>

    <hr class="da-sb-divider"/>

    <div class="da-sb-group">
      <div class="da-sb-lbl">Utilisateurs</div>
      <button class="da-sb-item" data-section="utilisateurs" onclick="nav(this)">
        <span class="ic">ğŸ‘¤</span> Utilisateurs
      </button>
      <button class="da-sb-item" data-section="messages" onclick="nav(this)">
        <span class="ic">ğŸ’¬</span> Conversations
      </button>
    </div>

    <hr class="da-sb-divider"/>

    <div class="da-sb-group">
      <div class="da-sb-lbl">SystÃ¨me</div>
      <button class="da-sb-item" data-section="notifications" onclick="nav(this)">
        <span class="ic">ğŸ””</span> Notifications
      </button>
      <button class="da-sb-item" data-section="audit" onclick="nav(this)">
        <span class="ic">ğŸ”</span> Audit
      </button>
    </div>

    <div class="da-sb-footer">
      
      <a href="{% url 'products:accueil' %}">ğŸ  &nbsp;Retour au site</a>
    </div>
  </aside>

  <!-- â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â• -->
  <main class="da-main">

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€ OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="sec-overview" class="da-section shown">
      <div class="da-ph">
        <div>
          <h1>Tableau de bord</h1>
          <div class="da-ph-sub" id="date-now"></div>
        </div>
        <a href="{% url 'products:ajouter' %}" class="da-btn-primary">ï¼‹ Ajouter produit</a>
      </div>

      <!-- KPIs -->
      <div class="da-kpi-grid">
        <div class="da-kpi">
          <div class="da-kpi-accent" style="background:var(--orange);"></div>
          <div class="da-kpi-icon" style="background:#fff3e8;">ğŸ“¦</div>
          <div class="da-kpi-val" id="kpi-produits">â€”</div>
          <div class="da-kpi-lbl">Produits actifs</div>
          <div class="da-kpi-trend" id="kpi-produits-t" style="color:#94a3b8;"></div>
        </div>
        <div class="da-kpi">
          <div class="da-kpi-accent" style="background:var(--blue);"></div>
          <div class="da-kpi-icon" style="background:#eff4ff;">ğŸ›’</div>
          <div class="da-kpi-val" id="kpi-commandes">â€”</div>
          <div class="da-kpi-lbl">Commandes totales</div>
          <div class="da-kpi-trend" id="kpi-commandes-t" style="color:#94a3b8;"></div>
        </div>
        <div class="da-kpi">
          <div class="da-kpi-accent" style="background:var(--green);"></div>
          <div class="da-kpi-icon" style="background:#ecfdf5;">ğŸ‘¤</div>
          <div class="da-kpi-val" id="kpi-users">â€”</div>
          <div class="da-kpi-lbl">Utilisateurs inscrits</div>
          <div class="da-kpi-trend" id="kpi-users-t" style="color:#94a3b8;"></div>
        </div>
        <div class="da-kpi">
          <div class="da-kpi-accent" style="background:var(--yellow);"></div>
          <div class="da-kpi-icon" style="background:#fffbeb;">â­</div>
          <div class="da-kpi-val" id="kpi-avis">â€”</div>
          <div class="da-kpi-lbl">Avis clients</div>
          <div class="da-kpi-trend" id="kpi-avis-t" style="color:#94a3b8;"></div>
        </div>
      </div>

      <!-- Row : Commandes rÃ©centes + Actions rapides -->
      <div class="da-row da-row-3-1">
        <div class="da-card">
          <div class="da-card-hd">
            <h3>ğŸ›’ Commandes rÃ©centes</h3>
            <button class="link" onclick="nav(document.querySelector('[data-section=commandes]'))">Voir tout â†’</button>
          </div>
          <table class="da-table">
            <thead><tr><th>RÃ©fÃ©rence</th><th>Client</th><th>Montant</th><th>Date</th><th>Statut</th></tr></thead>
            <tbody id="ov-commandes"><tr><td colspan="5" class="da-loading">Chargementâ€¦</td></tr></tbody>
          </table>
        </div>
        <div class="da-card">
          <div class="da-card-hd"><h3>âš¡ Actions rapides</h3></div>
          <div class="qa-list">
            <a href="{% url 'products:ajouter' %}" class="qa or">
              <span class="qa-ico">â•</span> Ajouter un produit
            </a>
            <a href="#" onclick="nav(document.querySelector('[data-section=commandes]'))" class="qa bl">
              <span class="qa-ico">ğŸ›’</span> Commandes en attente
            </a>
            <a href="#" onclick="nav(document.querySelector('[data-section=avis]'))" class="qa bl">
              <span class="qa-ico">â­</span> Avis Ã  modÃ©rer
            </a>
            <button class="qa gr" onclick="nav(document.querySelector('[data-section=stocks]'))">
              <span class="qa-ico">âš ï¸</span> VÃ©rifier les stocks
            </button>
            <a href="#" onclick="nav(document.querySelector('[data-section=utilisateurs]'))" class="qa bl">
              <span class="qa-ico">ğŸ‘¤</span> GÃ©rer utilisateurs
            </a>
          </div>
        </div>
      </div>

      <!-- Row : Stocks faibles + ActivitÃ© rÃ©cente -->
      <div class="da-row da-row-2">
        <div class="da-card">
          <div class="da-card-hd">
            <h3>âš ï¸ Alertes stocks</h3>
            <a href="/produits/">GÃ©rer â†’</a>
          </div>
          <div id="ov-stocks"><div class="da-loading">Chargementâ€¦</div></div>
        </div>
        <div class="da-card">
          <div class="da-card-hd">
            <h3>ğŸ” ActivitÃ© rÃ©cente</h3>
            <button class="link" onclick="nav(document.querySelector('[data-section=audit]'))">Tout voir â†’</button>
          </div>
          <div id="ov-activity"><div class="da-loading">Chargementâ€¦</div></div>
        </div>
      </div>

      <!-- Vue systÃ¨me -->
      <div class="da-card">
        <div class="da-card-hd"><h3>ğŸ“¡ Vue systÃ¨me</h3></div>
        <div class="da-mini">
          <div class="da-mini-cell">
            <div class="da-mini-val" id="ms-convs">â€”</div>
            <div class="da-mini-lbl">Conversations chat</div>
          </div>
          <div class="da-mini-cell">
            <div class="da-mini-val" id="ms-notifs">â€”</div>
            <div class="da-mini-lbl">Notifications envoyÃ©es</div>
          </div>
          <div class="da-mini-cell">
            <div class="da-mini-val" id="ms-paniers">â€”</div>
            <div class="da-mini-lbl">Paniers non vides</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€ PRODUITS â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="sec-produits" class="da-section">
      <div class="da-ph">
        <div><h1>Produits</h1><div class="da-ph-sub">Gestion du catalogue</div></div>
        <a href="{% url 'products:ajouter' %}" class="da-btn-primary">ï¼‹ Ajouter</a>
      </div>
      <div class="da-card">
        <div class="da-card-hd">
          <h3>Tous les produits</h3>
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="view-toggle">
              <button class="vt-btn active" id="vt-prod-table" onclick="setView('produits','table')" title="Tableau">â˜°</button>
              <button class="vt-btn" id="vt-prod-card" onclick="setView('produits','card')" title="Cartes">âŠ</button>
            </div>
            <a href="/produits/ajouter/">Ajouter â†’</a>
          </div>
        </div>
        <table class="da-table" id="view-produits-table">
          <thead><tr><th>Produit</th><th>CatÃ©gorie</th><th>Prix</th><th>Stock</th><th>Statut</th><th></th></tr></thead>
          <tbody id="tbl-produits"><tr><td colspan="6" class="da-loading">Chargementâ€¦</td></tr></tbody>
        </table>
        <div id="view-produits-card" class="card-grid" style="display:none;"></div>
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€ CATÃ‰GORIES â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="sec-categories" class="da-section">
      <div class="da-ph">
        <div><h1>CatÃ©gories</h1><div class="da-ph-sub">Arborescence du catalogue</div></div>
        <a href="/administration/categories/" class="da-btn-primary">ï¼‹ Ajouter</a>
      </div>
      <div class="da-card">
        <div class="da-card-hd">
          <h3>Toutes les catÃ©gories</h3>
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="view-toggle">
              <button class="vt-btn active" id="vt-cat-table" onclick="setView('categories','table')" title="Tableau">â˜°</button>
              <button class="vt-btn" id="vt-cat-card" onclick="setView('categories','card')" title="Cartes">âŠ</button>
            </div>
            <a href="/administration/categories/">GÃ©rer â†’</a>
          </div>
        </div>
        <table class="da-table" id="view-categories-table">
          <thead><tr><th>Nom</th><th>Slug</th><th>Niveau</th><th>Produits</th></tr></thead>
          <tbody id="tbl-categories"><tr><td colspan="4" class="da-loading">Chargementâ€¦</td></tr></tbody>
        </table>
        <div id="view-categories-card" class="card-grid" style="display:none;"></div>
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€ STOCKS â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="sec-stocks" class="da-section">
      <div class="da-ph">
        <div><h1>Stocks</h1><div class="da-ph-sub">Gestion des stocks</div></div>
        <a href="/produits/ajouter/" class="da-btn-primary">ï¼‹ Nouveau produit</a>
      </div>
      <!-- KPIs stocks -->
      <div class="da-kpi-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:20px;">
        <div class="da-kpi"><div class="da-kpi-accent" style="background:var(--blue);"></div><div class="da-kpi-icon" style="background:#eff4ff;">ğŸ“¦</div><div class="da-kpi-val" id="kpi-stock-total">â€”</div><div class="da-kpi-lbl">Produits total</div></div>
        <div class="da-kpi"><div class="da-kpi-accent" style="background:var(--orange);"></div><div class="da-kpi-icon" style="background:#fff7ed;">âš ï¸</div><div class="da-kpi-val" id="kpi-stock-faible">â€”</div><div class="da-kpi-lbl">Stock faible</div></div>
        <div class="da-kpi"><div class="da-kpi-accent" style="background:var(--red);"></div><div class="da-kpi-icon" style="background:#fff5f5;">ğŸ”´</div><div class="da-kpi-val" id="kpi-stock-zero">â€”</div><div class="da-kpi-lbl">Ã‰puisÃ©s</div></div>
      </div>
      <!-- Filtres -->
      <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
        <button class="st-filter-btn active" onclick="filtreStock('tous',this)">Tous</button>
        <button class="st-filter-btn" onclick="filtreStock('faible',this)">âš ï¸ Stock faible</button>
        <button class="st-filter-btn" onclick="filtreStock('epuise',this)">ğŸ”´ Ã‰puisÃ©s</button>
        <button class="st-filter-btn" onclick="filtreStock('ok',this)">âœ… Stock OK</button>
      </div>
      <div class="da-card">
        <div class="da-card-hd"><h3 id="stocks-title">Tous les produits</h3><span style="font-size:11.5px;color:#94a3b8;">Cliquez sur "RÃ©appro" pour ajuster le stock</span></div>
        <table class="da-table">
          <thead><tr><th>Produit</th><th>CatÃ©gorie</th><th>Stock actuel</th><th>Seuil</th><th>Niveau</th><th>Action</th></tr></thead>
          <tbody id="tbl-stocks"><tr><td colspan="6" class="da-loading">Chargementâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- MODAL RÃ‰APPROVISIONNEMENT STOCK -->
    <div id="modal-stock" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;padding:20px;">
      <div style="background:white;border-radius:14px;padding:28px;max-width:420px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.2);">
        <div style="font-size:16px;font-weight:700;color:#0D1F5C;margin-bottom:4px;" id="modal-stock-nom">Ajustement stock</div>
        <div style="font-size:12px;color:#94a3b8;margin-bottom:20px;">Stock actuel : <strong id="modal-stock-current">â€”</strong></div>
        <div style="margin-bottom:14px;">
          <label style="font-size:11px;font-weight:700;color:#0D1F5C;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px;">Type de mouvement</label>
          <select id="modal-stock-type" style="width:100%;padding:9px 12px;border-radius:8px;border:1.5px solid #e2e8f8;font-size:13px;font-family:'DM Sans',sans-serif;">
            <option value="entree">ğŸ“¥ EntrÃ©e (rÃ©approvisionnement)</option>
            <option value="sortie">ğŸ“¤ Sortie (retrait)</option>
            <option value="ajustement">ğŸ”§ Ajustement (valeur exacte)</option>
          </select>
        </div>
        <div style="margin-bottom:14px;">
          <label style="font-size:11px;font-weight:700;color:#0D1F5C;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px;">QuantitÃ©</label>
          <input type="number" id="modal-stock-qty" min="1" value="10" style="width:100%;padding:9px 12px;border-radius:8px;border:1.5px solid #e2e8f8;font-size:13px;font-family:'DM Sans',sans-serif;box-sizing:border-box;" />
        </div>
        <div style="margin-bottom:20px;">
          <label style="font-size:11px;font-weight:700;color:#0D1F5C;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px;">Note (optionnel)</label>
          <input type="text" id="modal-stock-note" placeholder="Ex: Livraison fournisseur, retour clientâ€¦" style="width:100%;padding:9px 12px;border-radius:8px;border:1.5px solid #e2e8f8;font-size:13px;font-family:'DM Sans',sans-serif;box-sizing:border-box;" />
        </div>
        <div style="display:flex;gap:10px;">
          <button onclick="closeStockModal()" style="flex:1;padding:10px;border-radius:8px;border:1.5px solid #e2e8f8;background:white;font-weight:600;font-size:13px;cursor:pointer;">Annuler</button>
          <button onclick="submitStock()" style="flex:1;padding:10px;border-radius:8px;border:none;background:linear-gradient(135deg,#F97316,#ea6000);color:white;font-weight:600;font-size:13px;cursor:pointer;">âœ“ Valider</button>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€ COMMANDES â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="sec-commandes" class="da-section">
      <div class="da-ph">
        <div><h1>Commandes</h1><div class="da-ph-sub">Suivi et gestion des commandes clients</div></div>
      </div>
      <div class="da-card">
        <div class="da-card-hd"><h3>Toutes les commandes</h3><span style="font-size:11.5px;color:#94a3b8;">Cliquez sur une action pour changer le statut</span></div>
        <table class="da-table">
          <thead><tr><th>RÃ©fÃ©rence</th><th>Client</th><th>Montant</th><th>Date</th><th>Statut</th><th>Actions</th></tr></thead>
          <tbody id="tbl-commandes"><tr><td colspan="6" class="da-loading">Chargementâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€ AVIS â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="sec-avis" class="da-section">
      <div class="da-ph">
        <div><h1>Avis clients</h1><div class="da-ph-sub">ModÃ©ration des avis</div></div>
      </div>
      <div class="da-card">
        <div class="da-card-hd"><h3>Tous les avis</h3><span style="font-size:11.5px;color:#94a3b8;">Valider ou supprimer les avis depuis ce tableau</span></div>
        <table class="da-table">
          <thead><tr><th>Produit</th><th>Client</th><th>Note</th><th>Commentaire</th><th>Statut</th><th>Actions</th></tr></thead>
          <tbody id="tbl-avis"><tr><td colspan="6" class="da-loading">Chargementâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€ PANIERS â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="sec-paniers" class="da-section">
      <div class="da-ph"><div><h1>Paniers actifs</h1><div class="da-ph-sub">Paniers non finalisÃ©s par les clients</div></div></div>
      <div class="da-card">
        <div class="da-card-hd"><h3>Paniers en cours</h3></div>
        <table class="da-table">
          <thead><tr><th>Utilisateur</th><th>Email</th><th>Articles</th><th>Montant estimÃ©</th><th>DerniÃ¨re activitÃ©</th></tr></thead>
          <tbody id="tbl-paniers"><tr><td colspan="5" class="da-loading">Chargementâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€ UTILISATEURS â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="sec-utilisateurs" class="da-section">
      <div class="da-ph"><div><h1>Utilisateurs</h1><div class="da-ph-sub">Gestion des comptes clients</div></div></div>
      <div class="da-card">
        <div class="da-card-hd"><h3>Tous les comptes</h3></div>
        <table class="da-table">
          <thead><tr><th>Nom</th><th>Email</th><th>TÃ©lÃ©phone</th><th>Inscription</th><th>Email vÃ©rifiÃ©</th><th>Statut</th><th>Action</th></tr></thead>
          <tbody id="tbl-users"><tr><td colspan="7" class="da-loading">Chargementâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€ MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="sec-messages" class="da-section">
      <div class="da-ph"><div><h1>Conversations</h1><div class="da-ph-sub">Messages entre utilisateurs</div></div></div>
      <div class="da-card">
        <div class="da-card-hd"><h3>Toutes les conversations</h3><a href="#" onclick="nav(document.querySelector('[data-section=messages]'))"></span></div>
        <table class="da-table">
          <thead><tr><th>Participants</th><th>Dernier message</th><th>Messages non lus</th><th>Date</th></tr></thead>
          <tbody id="tbl-messages"><tr><td colspan="4" class="da-loading">Chargementâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€ NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="sec-notifications" class="da-section">
      <div class="da-ph"><div><h1>Notifications</h1><div class="da-ph-sub">Historique des notifications</div></div></div>
      <div class="da-card">
        <div class="da-card-hd"><h3>Notifications rÃ©centes</h3><a href="#" onclick="nav(document.querySelector('[data-section=notifications]'))"></span></div>
        <table class="da-table">
          <thead><tr><th>Type</th><th>Destinataire</th><th>Titre</th><th>Date</th><th>Lu</th></tr></thead>
          <tbody id="tbl-notifs"><tr><td colspan="5" class="da-loading">Chargementâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€ AUDIT â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="sec-audit" class="da-section">
      <div class="da-ph"><div><h1>Journal d'audit</h1><div class="da-ph-sub">TraÃ§abilitÃ© des actions</div></div></div>
      <div class="da-card">
        <div class="da-card-hd"><h3>ActivitÃ© du systÃ¨me</h3><a href="#" onclick="nav(document.querySelector('[data-section=audit]'))"></span></div>
        <div id="tbl-audit"><div class="da-loading">Chargementâ€¦</div></div>
      </div>
    </div>

  </main>
</div>
{% endblock %}

{% block footer %}{% include 'partials/footer.html' %}{% endblock %}

{% block extra_scripts %}
<script>
/* â”€â”€â”€ Helpers â”€â”€â”€ */
const $ = id => document.getElementById(id);
const fmtDate = d => new Date(d).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'});
const fmtPrice = p => parseFloat(p||0).toLocaleString('fr-FR') + ' FCFA';
const mono = t => `<span class="mono">${t}</span>`;
const bold = t => `<span class="bold">${t}</span>`;
const empty = (cols, msg='Aucune donnÃ©e') => `<tr><td colspan="${cols}" class="da-empty">${msg}</td></tr>`;
const loading = cols => `<tr><td colspan="${cols}" class="da-loading">Chargementâ€¦</td></tr>`;

const STATUTS = {
  en_attente:'<span class="st st-wait">En attente</span>',
  confirmee:'<span class="st st-conf">ConfirmÃ©e</span>',
  en_preparation:'<span class="st st-prep">En prÃ©paration</span>',
  expediee:'<span class="st st-ship">ExpÃ©diÃ©e</span>',
  livree:'<span class="st st-done">LivrÃ©e</span>',
  annulee:'<span class="st st-cancel">AnnulÃ©e</span>',
};
const statut = s => STATUTS[s] || `<span class="st st-off">${s}</span>`;

const stars = n => 'â˜…'.repeat(n) + 'â˜†'.repeat(5-n);

/* â”€â”€â”€ Navigation â”€â”€â”€ */
const ALL_SECTIONS = ['overview','produits','categories','stocks','commandes','avis','paniers','utilisateurs','messages','notifications','audit'];
const loaded = new Set();

function nav(btn) {
  const name = btn.dataset.section;
  document.querySelectorAll('.da-sb-item').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  ALL_SECTIONS.forEach(s => {
    const el = $('sec-'+s);
    if (el) el.className = 'da-section' + (s === name ? ' shown' : '');
  });
  if (!loaded.has(name)) { loadSection(name); loaded.add(name); }
  // Save current section in URL hash (persists on refresh)
  history.replaceState(null, '', '#' + name);
}

// Restore section from URL hash on page load
function restoreSection() {
  const hash = window.location.hash.replace('#', '');
  if (hash && ALL_SECTIONS.includes(hash)) {
    const btn = document.querySelector('[data-section="' + hash + '"]');
    if (btn) { nav(btn); return; }
  }
  // Default: load overview
  const btn = document.querySelector('[data-section="overview"]');
  if (btn) nav(btn);
}

/* â”€â”€â”€ API Calls â”€â”€â”€ */
async function apiFetch(url) {
  try {
    const r = await API.get(url, { silentError: true });
    return r?.results ?? r ?? [];
  } catch { return []; }
}

/* â”€â”€â”€ OVERVIEW â”€â”€â”€ */
async function loadOverview() {
  $('date-now').textContent = new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

  const [produits, commandes, avis, cats] = await Promise.all([
    apiFetch('/api/produits/?page_size=100'),
    apiFetch('/api/commandes/'),
    apiFetch('/api/avis/'),
    apiFetch('/api/categories/'),
  ]);

  /* KPIs */
  $('kpi-produits').textContent = produits.length || 'â€”';
  $('kpi-produits-t').innerHTML = `<span style="color:var(--green);">â–²</span> ${cats.length} catÃ©gorie${cats.length>1?'s':''}`;

  $('kpi-commandes').textContent = commandes.length || 'â€”';
  const pending = commandes.filter(c=>c.statut==='en_attente').length;
  $('kpi-commandes-t').innerHTML = pending ? `<span style="color:var(--orange);">â–² ${pending} en attente</span>` : `<span style="color:var(--green);">âœ“ Aucune en attente</span>`;
  if (pending) { $('chip-commandes').textContent = pending; $('chip-commandes').style.display='flex'; }

  $('kpi-avis').textContent = avis.length || 'â€”';
  const nonVal = avis.filter(a=>!a.is_validated).length;
  $('kpi-avis-t').innerHTML = nonVal ? `<span style="color:var(--yellow);">â–² ${nonVal} Ã  valider</span>` : `<span style="color:var(--green);">âœ“ Tous validÃ©s</span>`;
  if (nonVal) { $('chip-avis').textContent = nonVal; $('chip-avis').style.display='flex'; }

  /* Stock alertes */
  const stockFaible = produits.filter(p => p.stock <= (p.stock_minimum || 5));
  if (stockFaible.length) { $('chip-stocks').textContent = stockFaible.length; $('chip-stocks').style.display='flex'; }

  /* users count via context or placeholder */
  $('kpi-users').textContent = '{{ users_count|default:"â€”" }}';
  $('kpi-users-t').innerHTML = '<span style="color:var(--green);">â–² Actifs</span>';

  /* Commandes rÃ©centes */
  const recent = commandes.slice(0,7);
  $('ov-commandes').innerHTML = recent.length ? recent.map(c=>`
    <tr>
      <td>${mono('#' + (c.reference_courte || String(c.id).slice(-6)))}</td>
      <td>${bold(c.client_nom || c.client || 'â€”')}</td>
      <td>${mono(fmtPrice(c.montant_total))}</td>
      <td>${mono(fmtDate(c.date_creation))}</td>
      <td>${statut(c.statut)}</td>
    </tr>`).join('') : empty(5,'Aucune commande');

  /* Stocks faibles */
  if (!stockFaible.length) {
    $('ov-stocks').innerHTML = '<div style="padding:20px;text-align:center;color:var(--green);font-size:13px;font-weight:600;">Aucun produit en stock pour le moment</div>';
  } else {
    $('ov-stocks').innerHTML = stockFaible.slice(0,6).map(p => {
      const pct = Math.min(100, Math.round(p.stock/Math.max((p.stock_minimum||5)*2,1)*100));
      const cls = pct<20?'sk-cr':pct<50?'sk-lo':'sk-ok';
      const col = pct<20?'var(--red)':pct<50?'var(--orange)':'var(--green)';
      return `<div class="sk-row">
        <div style="flex:1;min-width:0;">
          <div style="font-size:12.5px;font-weight:600;color:var(--navy);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.nom}</div>
          <div style="font-size:11px;color:#94a3b8;">${p.categorie_nom||'â€”'}</div>
        </div>
        <div class="sk-bar-bg" style="width:80px;"><div class="sk-bar ${cls}" style="width:${pct}%;"></div></div>
        <span style="font-family:'DM Mono',monospace;font-size:11.5px;color:${col};font-weight:700;min-width:30px;text-align:right;">${p.stock}</span>
      </div>`;
    }).join('');
  }

  /* ActivitÃ© (commandes rÃ©centes feed) */
  $('ov-activity').innerHTML = commandes.slice(0,8).map(c => {
    const col = c.statut==='annulee'?'var(--red)':c.statut==='en_attente'?'var(--orange)':'var(--blue-l)';
    return `<div class="af-item">
      <div class="af-dot" style="background:${col};"></div>
      <div>
        <div class="af-text">Commande <strong>#${c.reference_courte||c.id}</strong> Â· ${c.client_nom||'client'} ${statut(c.statut)}</div>
        <div class="af-time">${fmtDate(c.date_creation)}</div>
      </div>
    </div>`;
  }).join('') || '<div class="da-empty">Aucune activitÃ©</div>';

  /* Mini stats */
  try {
    const chats = await apiFetch('/api/chat/');
    $('ms-convs').textContent = Array.isArray(chats) ? chats.length : 'â€”';
  } catch {}
  try {
    const notifs = await apiFetch('/api/notifications/?page_size=1');
    $('ms-notifs').textContent = notifs?.count ?? (Array.isArray(notifs)?notifs.length:'â€”');
  } catch {}
  $('ms-paniers').textContent = '{{ paniers_count|default:"â€”" }}';
}

/* â”€â”€â”€ STOCK RENDER & FILTER â”€â”€â”€ */
function renderStockRow(p) {
  const min = p.stock_minimum || 5;
  const s   = p.stock;
  const pct = s === 0 ? 0 : Math.min(100, Math.round(s / Math.max(min * 2, 1) * 100));
  const col = s === 0 ? 'var(--red)' : s <= min ? 'var(--orange)' : 'var(--green)';
  const cls = s === 0 ? 'sk-cr'      : s <= min ? 'sk-lo'         : 'sk-ok';
  const badge = s === 0
    ? '<span class="st" style="background:#fee2e2;color:var(--red);border:none;">Ã‰puisÃ©</span>'
    : s <= min
      ? '<span class="st" style="background:#fff7ed;color:var(--orange);border:none;">âš  Faible</span>'
      : '<span class="st st-active">OK</span>';
  const imgSrc = p.image_principale || '';
  return `<tr>
    <td>
      <div style="display:flex;align-items:center;gap:10px;">
        ${imgSrc ? `<img src="${imgSrc}" style="width:36px;height:36px;border-radius:6px;object-fit:cover;flex-shrink:0;border:1px solid #e2e8f0;">` : `<div style="width:36px;height:36px;border-radius:6px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">ğŸ“¦</div>`}
        <div>
          <div style="font-size:13px;font-weight:600;color:var(--navy);">${p.nom}</div>
          ${badge}
        </div>
      </div>
    </td>
    <td style="color:#64748b;">${p.categorie_nom||'â€”'}</td>
    <td style="font-family:'DM Mono',monospace;font-weight:700;color:${col};font-size:14px;">${s}</td>
    <td style="color:#94a3b8;font-family:monospace;">${min}</td>
    <td>
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="sk-bar-bg" style="width:90px;"><div class="sk-bar ${cls}" style="width:${pct}%;"></div></div>
        <span style="font-size:11px;color:${col};font-weight:700;min-width:30px;">${pct}%</span>
      </div>
    </td>
    <td><button onclick="openStockModal(${p.id},'${p.nom.replace(/'/g,"\'")}',${p.stock})" style="padding:5px 12px;border-radius:6px;border:1.5px solid #bfdbfe;background:#eff6ff;color:var(--blue-l);font-size:11.5px;font-weight:600;cursor:pointer;">ğŸ“¦ RÃ©appro</button></td>
  </tr>`;
}

function renderStocks(data) {
  const tbl = $('tbl-stocks');
  if (!tbl) return;
  tbl.innerHTML = data.length
    ? data.map(renderStockRow).join('')
    : `<tr><td colspan="6" class="da-empty">Aucun produit trouvÃ©</td></tr>`;
}

function filtreStock(type, btn) {
  document.querySelectorAll('.st-filter-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const all = window._stocksData || [];
  const titleEl = $('stocks-title');
  let data;
  if (type === 'faible') {
    data = all.filter(p => p.stock > 0 && p.stock <= (p.stock_minimum || 5));
    if (titleEl) titleEl.textContent = 'âš ï¸ Produits stock faible';
  } else if (type === 'epuise') {
    data = all.filter(p => p.stock === 0);
    if (titleEl) titleEl.textContent = 'ğŸ”´ Produits Ã©puisÃ©s';
  } else if (type === 'ok') {
    data = all.filter(p => p.stock > (p.stock_minimum || 5));
    if (titleEl) titleEl.textContent = 'âœ… Produits stock OK';
  } else {
    data = all;
    if (titleEl) titleEl.textContent = 'Tous les produits';
  }
  renderStocks(data);
}

/* â”€â”€â”€ VIEW TOGGLE â”€â”€â”€ */
const viewState = {};
function setView(section, mode) {
  viewState[section] = mode;
  const tableEl = document.getElementById('view-' + section + '-table');
  const cardEl  = document.getElementById('view-' + section + '-card');
  const btnT    = document.getElementById('vt-' + section.replace('categories','cat').replace('produits','prod') + '-table');
  const btnC    = document.getElementById('vt-' + section.replace('categories','cat').replace('produits','prod') + '-card');
  if (tableEl) tableEl.style.display = mode === 'table' ? '' : 'none';
  if (cardEl)  cardEl.style.display  = mode === 'card'  ? '' : 'none';
  if (btnT) { btnT.classList.toggle('active', mode==='table'); }
  if (btnC) { btnC.classList.toggle('active', mode==='card'); }
}

/* â”€â”€â”€ SECTIONS â”€â”€â”€ */
async function loadSection(name) {
  if (name === 'overview') { restoreSection(); return; }

  if (name === 'produits') {
    const d = await apiFetch('/api/produits/?page_size=100');
    $('tbl-produits').innerHTML = d.length ? d.map(p=>{
      const s=p.stock; const min=p.stock_minimum||5;
      const sCol = s===0?'var(--red)':s<=min?'var(--orange)':'var(--green)';
      const imgSrc = p.image_principale || (p.images&&p.images[0]?.image) || '';
      return `<tr>
        <td>
          <div style="display:flex;align-items:center;gap:10px;">
            ${imgSrc ? `<img src="${imgSrc}" alt="${p.nom}" style="width:40px;height:40px;border-radius:6px;object-fit:cover;flex-shrink:0;border:1px solid #e2e8f0;">` : `<div style="width:40px;height:40px;border-radius:6px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">ğŸ“¦</div>`}
            <span style="font-size:13px;font-weight:600;color:var(--navy);">${p.nom}</span>
          </div>
        </td>
        <td style="color:#64748b;">${p.categorie_nom||'â€”'}</td>
        <td>${mono(fmtPrice(p.prix))}</td>
        <td style="font-family:'DM Mono',monospace;font-weight:700;color:${sCol};">${s}</td>
        <td>${p.statut==='actif'?'<span class="st st-active">Actif</span>':'<span class="st st-off">Inactif</span>'}</td>
        <td><a href="/produits/modifier/${p.id}/" style="font-size:11.5px;color:var(--blue-l);text-decoration:none;font-weight:600;">Modifier â†’</a></td>
      </tr>`;
    }).join('') : empty(6);

    // Card view
    const cardGrid = $('view-produits-card');
    if (cardGrid) {
      cardGrid.innerHTML = d.length ? d.map(p => {
        const imgSrc = p.image_principale || (p.images&&p.images[0]?.image) || '';
        const s=p.stock; const min=p.stock_minimum||5;
        const sCol = s===0?'#ef4444':s<=min?'#f97316':'#22c55e';
        return `<div class="prod-card">
          ${imgSrc ? `<img src="${imgSrc}" class="prod-card-img" onerror="this.src='/static/img/logo.svg'">` : `<div class="prod-card-img" style="display:flex;align-items:center;justify-content:center;font-size:40px;">ğŸ“¦</div>`}
          <div class="prod-card-body">
            <div class="prod-card-name">${p.nom}</div>
            <div class="prod-card-meta">${p.categorie_nom||'â€”'} Â· <span style="color:${sCol};font-weight:700;">${s} en stock</span></div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-top:6px;">
              <span class="prod-card-price">${fmtPrice(p.prix_promo||p.prix)} FCFA</span>
              <a href="/produits/modifier/${p.id}/" style="font-size:11px;color:var(--blue-l);font-weight:600;text-decoration:none;">Modifier â†’</a>
            </div>
          </div>
        </div>`;
      }).join('') : '<p style="padding:20px;color:#94a3b8;text-align:center;">Aucun produit</p>';
    }
  }

  if (name === 'categories') {
    const raw = await apiFetch('/api/categories/');
    // Flatten nested tree into flat list with level
    function flattenCats(cats, level=0) {
      let result = [];
      for (const cat of cats) {
        result.push({...cat, _level: level});
        if (cat.sous_categories?.length) result = result.concat(flattenCats(cat.sous_categories, level+1));
      }
      return result;
    }
    const d = flattenCats(Array.isArray(raw) ? raw : []);
    $('tbl-categories').innerHTML = d.length ? d.map(c=>`<tr>
      <td style="padding-left:${(c._level||0)*20+16}px;">${'â”” '.repeat(c._level||0)}${bold(c.nom)}</td>
      <td>${mono(c.slug)}</td>
      <td><span class="st st-off">Niveau ${c._level||0}</span></td>
      <td style="color:#64748b;">${c.nombre_produits||'â€”'}</td>
    </tr>`).join('') : empty(4);

    // Card view
    const catGrid = $('view-categories-card');
    if (catGrid) {
      catGrid.innerHTML = d.length ? d.map(cat => {
        const imgSrc = cat.image || '';
        const indent = cat._level > 0 ? `<span style="font-size:10px;color:#94a3b8;margin-right:4px;">${'â”” '.repeat(cat._level)}</span>` : '';
        return `<div class="cat-card">
          ${imgSrc ? `<img src="${imgSrc}" class="prod-card-img" style="aspect-ratio:1;object-fit:cover;width:100%;" onerror="this.style.display='none'">` : `<div class="cat-card-img">ğŸ—‚ï¸</div>`}
          <div class="cat-card-body">
            <div class="cat-card-name">${indent}${cat.nom}</div>
            <div class="cat-card-meta">${cat._level===0?'CatÃ©gorie principale':'Sous-catÃ©gorie'} Â· ${cat.nombre_produits||0} produit(s)</div>
            <div style="margin-top:6px;">
              <a href="/administration/categories/?modifier=${cat.id}" style="font-size:11px;color:var(--blue-l);font-weight:600;text-decoration:none;">Modifier â†’</a>
            </div>
          </div>
        </div>`;
      }).join('') : '<p style="padding:20px;color:#94a3b8;text-align:center;">Aucune catÃ©gorie</p>';
    }
  }

  if (name === 'stocks') {
    window._stocksData = await apiFetch('/api/produits/?page_size=200');
    const all = window._stocksData;
    // KPIs
    const faible = all.filter(p=>p.stock>0 && p.stock<=(p.stock_minimum||5));
    const zero   = all.filter(p=>p.stock===0);
    if($('kpi-stock-total'))  $('kpi-stock-total').textContent  = all.length;
    if($('kpi-stock-faible')) $('kpi-stock-faible').textContent = faible.length;
    if($('kpi-stock-zero'))   $('kpi-stock-zero').textContent   = zero.length;
    renderStocks(all);
  }


  if (name === 'commandes') {
    const d = await apiFetch('/api/commandes/');
    const nextStatut = {en_attente:'confirmer',confirmee:'mettre_en_preparation',en_preparation:'expedier',expediee:'livrer'};
    const nextLabel  = {en_attente:'âœ“ Confirmer',confirmee:'ğŸ”§ PrÃ©parer',en_preparation:'ğŸšš ExpÃ©dier',expediee:'ğŸ“¬ Livrer'};
    $('tbl-commandes').innerHTML = d.length ? d.map(c=>`<tr>
      <td>${mono('#'+(c.reference_courte||String(c.id).slice(-6)))}</td>
      <td>${bold(c.client_nom||c.client||'â€”')}</td>
      <td>${mono(fmtPrice(c.montant_total))}</td>
      <td>${mono(fmtDate(c.date_creation))}</td>
      <td>${statut(c.statut)}</td>
      <td style="display:flex;gap:4px;flex-wrap:wrap;">
        ${nextStatut[c.statut]?`<button onclick="changerStatutCommande(${c.id},'${nextStatut[c.statut]}',this)" style="padding:4px 8px;border-radius:5px;border:none;background:var(--blue);color:white;font-size:11px;font-weight:600;cursor:pointer;">${nextLabel[c.statut]}</button>`:''}
        ${c.statut!=='livree'&&c.statut!=='annulee'?`<button onclick="annulerCommande(${c.id},this)" style="padding:4px 8px;border-radius:5px;border:1.5px solid #fecaca;background:#fff5f5;color:var(--red);font-size:11px;font-weight:600;cursor:pointer;">âœ• Annuler</button>`:'<span style="color:#94a3b8;font-size:11px;">â€”</span>'}
      </td>
    </tr>`).join('') : empty(6);
  }

  if (name === 'avis') {
    const d = await apiFetch('/api/avis/?all=1');
    $('tbl-avis').innerHTML = d.length ? d.map(a=>`<tr>
      <td>${bold(a.produit_nom||'â€”')}</td>
      <td>${a.auteur||'â€”'}</td>
      <td style="color:var(--yellow);letter-spacing:1px;">${stars(a.note)}</td>
      <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#64748b;">${a.commentaire||'â€”'}</td>
      <td>${a.is_validated?'<span class="st st-valid">ValidÃ©</span>':'<span class="st st-pend">Ã€ valider</span>'}</td>
      <td style="display:flex;gap:4px;">
        ${!a.is_validated?`<button onclick="validerAvis(${a.id},true,this)" style="padding:4px 8px;border-radius:5px;border:none;background:var(--green);color:white;font-size:11px;font-weight:600;cursor:pointer;">âœ“ Valider</button>`:`<button onclick="validerAvis(${a.id},false,this)" style="padding:4px 8px;border-radius:5px;border:1.5px solid #d1d5e8;background:white;color:#64748b;font-size:11px;cursor:pointer;">â†© Invalider</button>`}
        <button onclick="supprimerAvis(${a.id},this)" style="padding:4px 8px;border-radius:5px;border:1.5px solid #fecaca;background:#fff5f5;color:var(--red);font-size:11px;cursor:pointer;">ğŸ—‘</button>
      </td>
    </tr>`).join('') : empty(6);
  }

  if (name === 'paniers') {
    const d = await apiFetch('/api/panier/admin/');
    if (Array.isArray(d) && d.length) {
      $('tbl-paniers').innerHTML = d.map(p=>`<tr>
        <td>${bold(p.utilisateur||'â€”')}</td>
        <td style="color:#64748b;font-size:12px;">${p.utilisateur_email||'â€”'}</td>
        <td>${p.nb_articles||0} article(s)</td>
        <td>${mono(fmtPrice(p.montant_total||0))}</td>
        <td>${mono(fmtDate(p.date_modification||new Date()))}</td>
      </tr>`).join('');
    } else {
      $('tbl-paniers').innerHTML = empty(5,'Aucun panier actif pour le moment');
    }
  }

  if (name === 'utilisateurs') {
    try {
      const d = await apiFetch('/api/auth/utilisateurs/');
      $('tbl-users').innerHTML = d.length ? d.map(u=>`<tr>
        <td>${bold((u.prenom||'')+' '+(u.nom||u.username||''))}</td>
        <td>${mono(u.email)}</td>
        <td style="color:#64748b;">${u.telephone||'â€”'}</td>
        <td>${mono(fmtDate(u.date_inscription||new Date()))}</td>
        <td>${u.email_verifie?'<span class="st st-done">âœ“ VÃ©rifiÃ©</span>':'<span class="st st-pend">Non vÃ©rifiÃ©</span>'}</td>
        <td>${u.is_active?'<span class="st st-active">Actif</span>':'<span class="st st-off">Inactif</span>'}</td>
        <td><button onclick="toggleUser(${u.id},${u.is_active},this)" style="padding:4px 10px;border-radius:5px;border:1.5px solid ${u.is_active?'#fecaca':'#d1fae5'};background:${u.is_active?'#fff5f5':'#f0fdf4'};color:${u.is_active?'var(--red)':'var(--green)'};font-size:11px;font-weight:600;cursor:pointer;">${u.is_active?'ğŸš« DÃ©sactiver':'âœ“ Activer'}</button></td>
      </tr>`).join('') : empty(7);
    } catch {
      $('tbl-users').innerHTML = `<tr><td colspan="7" class="da-empty">Aucun utilisateur trouvÃ©</td></tr>`;
    }
  }

  if (name === 'messages') {
    const d = await apiFetch('/api/chat/');
    $('tbl-messages').innerHTML = Array.isArray(d) && d.length ? d.map(c=>`<tr>
      <td>${bold(c.interlocuteur?.username||c.participants?.join(' Â· ')||'â€”')}</td>
      <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#64748b;">${c.dernier_message?.contenu||'â€”'}</td>
      <td>${c.messages_non_lus>0?`<span class="st st-pend">${c.messages_non_lus} non lu${c.messages_non_lus>1?'s':''}</span>`:'<span style="color:#94a3b8;">0</span>'}</td>
      <td>${mono(fmtDate(c.derniere_activite||new Date()))}</td>
    </tr>`).join('') : empty(4,'Aucune conversation');
  }

  if (name === 'notifications') {
    const d = await apiFetch('/api/notifications/?page_size=30');
    const icones={commande:'ğŸ“¦',avis:'â­',stock:'âš ï¸',systeme:'â„¹ï¸'};
    $('tbl-notifs').innerHTML = Array.isArray(d) && d.length ? d.map(n=>`<tr>
      <td>${icones[n.type_notif]||'â„¹ï¸'} <span style="color:#64748b;">${n.type_notif||'â€”'}</span></td>
      <td>${n.utilisateur_nom||'â€”'}</td>
      <td>${bold(n.titre)}</td>
      <td>${mono(fmtDate(n.date_creation))}</td>
      <td>${n.is_read?'<span class="st st-done">Lu</span>':'<span class="st st-pend">Non lu</span>'}</td>
    </tr>`).join('') : empty(5);
  }

  if (name === 'audit') {
    const d = await apiFetch('/api/commandes/?page_size=25');
    $('tbl-audit').innerHTML = Array.isArray(d) && d.length ? d.map(c=>{
      const col = c.statut==='annulee'?'var(--red)':c.statut==='en_attente'?'var(--orange)':'var(--blue-l)';
      return `<div class="af-item">
        <div class="af-dot" style="background:${col};"></div>
        <div>
          <div class="af-text"><strong>#${c.reference_courte||c.id}</strong> â€” ${c.client_nom||'client'} ${statut(c.statut)} Â· ${mono(fmtPrice(c.montant_total))}</div>
          <div class="af-time">${fmtDate(c.date_creation)}</div>
        </div>
      </div>`;
    }).join('') : '<div class="da-empty">Aucune activitÃ©</div>';
  }
}

/* â”€â”€â”€ Init â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', () => {
  loaded.add('overview');
  loadOverview();
});

/* â”€â”€â”€ ACTIONS ADMIN â”€â”€â”€ */

// Variables modal stock
let stockProduitId = null;

function openStockModal(produitId, nom, stockActuel) {
  stockProduitId = produitId;
  document.getElementById('modal-stock-nom').textContent = 'ğŸ“¦ ' + nom;
  document.getElementById('modal-stock-current').textContent = stockActuel + ' unitÃ©s';
  document.getElementById('modal-stock-qty').value = 10;
  document.getElementById('modal-stock-note').value = '';
  document.getElementById('modal-stock').style.display = 'flex';
}

function closeStockModal() {
  document.getElementById('modal-stock').style.display = 'none';
  stockProduitId = null;
}

async function submitStock() {
  if (!stockProduitId) return;
  const type_mouvement = document.getElementById('modal-stock-type').value;
  const quantite = parseInt(document.getElementById('modal-stock-qty').value);
  const note = document.getElementById('modal-stock-note').value;
  if (!quantite || quantite <= 0) { alert('QuantitÃ© invalide'); return; }
  try {
    await API.post(`/api/produits/${stockProduitId}/gerer_stock/`, { type_mouvement, quantite, note });
    closeStockModal();
    // RafraÃ®chir la section stocks
    loaded.delete('stocks');
    loadSection('stocks');
    showToast('Stock mis Ã  jour avec succÃ¨s', 'success');
  } catch(e) {
    showToast('Erreur lors de la mise Ã  jour du stock', 'error');
  }
}

async function changerStatutCommande(id, action, btn) {
  btn.disabled = true; btn.textContent = 'â€¦';
  try {
    await API.post(`/api/commandes/${id}/${action}/`, {});
    loaded.delete('commandes');
    loadSection('commandes');
    showToast('Statut commande mis Ã  jour', 'success');
  } catch(e) {
    showToast('Erreur : ' + (e.message||'impossible'), 'error');
    btn.disabled = false;
  }
}

async function annulerCommande(id, btn) {
  if (!confirm('Annuler cette commande ? Le stock sera remis Ã  jour.')) return;
  btn.disabled = true;
  try {
    await API.post(`/api/commandes/${id}/annuler/`, {});
    loaded.delete('commandes');
    loadSection('commandes');
    showToast('Commande annulÃ©e', 'success');
  } catch(e) {
    showToast('Erreur annulation', 'error');
    btn.disabled = false;
  }
}

async function validerAvis(id, valider, btn) {
  btn.disabled = true;
  try {
    const endpoint = valider ? 'valider' : 'invalider';
    await API.post(`/api/avis/${id}/${endpoint}/`, {});
    loaded.delete('avis');
    loadSection('avis');
    showToast(valider ? 'Avis validÃ©' : 'Avis invalidÃ©', 'success');
  } catch(e) {
    showToast('Erreur modÃ©ration avis', 'error');
    btn.disabled = false;
  }
}

async function supprimerAvis(id, btn) {
  if (!confirm('Supprimer dÃ©finitivement cet avis ?')) return;
  btn.disabled = true;
  try {
    await API.delete(`/api/avis/${id}/`);
    loaded.delete('avis');
    loadSection('avis');
    showToast('Avis supprimÃ©', 'success');
  } catch(e) {
    showToast('Erreur suppression avis', 'error');
    btn.disabled = false;
  }
}

async function toggleUser(id, isActive, btn) {
  const action = isActive ? 'dÃ©sactiver' : 'activer';
  if (!confirm(`Voulez-vous ${action} ce compte utilisateur ?`)) return;
  btn.disabled = true;
  try {
    await API.post(`/api/auth/utilisateurs/${id}/toggle_actif/`, {});
    loaded.delete('utilisateurs');
    loadSection('utilisateurs');
    showToast(`Compte ${action === 'activer' ? 'activÃ©' : 'dÃ©sactivÃ©'}`, 'success');
  } catch(e) {
    showToast('Erreur modification compte', 'error');
    btn.disabled = false;
  }
}

function showToast(msg, type) {
  const colors = { success: '#10b981', error: '#ef4444' };
  const div = document.createElement('div');
  div.style.cssText = `position:fixed;bottom:24px;right:24px;z-index:999;padding:12px 20px;border-radius:10px;background:${colors[type]||'#1E3A8A'};color:white;font-size:13px;font-weight:600;font-family:'DM Sans',sans-serif;box-shadow:0 4px 16px rgba(0,0,0,.2);animation:fadeIn .2s ease;`;
  div.textContent = (type === 'success' ? 'âœ“ ' : 'âœ• ') + msg;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 3000);
}

</script>
{% endblock %}