{% extends 'base.html' %}
{% load static %}

{% block title %}Commande confirmée — HooYia Market{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

  <!-- Succès -->
  <div class="text-center mb-10">
    <div class="h-20 w-20 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-4">
      <svg class="h-10 w-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
    </div>
    <h1 class="font-display text-3xl text-ink mb-2">Commande confirmée !</h1>
    <p class="text-ink/50 font-body">Merci pour votre achat. Vous recevrez une confirmation par email.</p>
  </div>

  <!-- Skeleton -->
  <div id="skeleton" class="card p-6 animate-pulse space-y-4">
    <div class="h-4 bg-cream-warm rounded w-1/3"></div>
    <div class="h-3 bg-cream-warm rounded w-1/2"></div>
    <div class="h-3 bg-cream-warm rounded w-2/3"></div>
  </div>

  <!-- Détail commande -->
  <div id="commande-detail" class="hidden space-y-6">

    <!-- Infos principales -->
    <div class="card p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-display text-lg text-ink">Commande <span id="ref-commande" class="text-brand-600"></span></h2>
        <span id="statut-badge" class="px-3 py-1 rounded-full text-xs font-body font-semibold"></span>
      </div>

      <!-- Statut timeline -->
      <div class="flex items-center gap-2 mb-6 overflow-x-auto pb-1" id="timeline"></div>

      <!-- Adresse livraison -->
      <div class="grid md:grid-cols-2 gap-4 pt-4 border-t border-cream-border">
        <div>
          <p class="text-xs font-body text-ink/40 uppercase tracking-wider mb-2">Livraison</p>
          <div id="adresse-livraison" class="font-body text-sm text-ink/70 space-y-0.5"></div>
        </div>
        <div>
          <p class="text-xs font-body text-ink/40 uppercase tracking-wider mb-2">Paiement</p>
          <div id="paiement-info" class="font-body text-sm text-ink/70"></div>
        </div>
      </div>
    </div>

    <!-- Articles -->
    <div class="card p-6">
      <h3 class="font-display text-lg text-ink mb-4">Articles commandés</h3>
      <div id="lignes-commande" class="space-y-3"></div>
      <div class="h-px bg-cream-border my-4"></div>
      <div class="flex justify-between font-body font-semibold text-ink">
        <span>Total payé</span>
        <span id="total-commande" class="text-brand-600"></span>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex flex-col sm:flex-row gap-3">
      <a href="{% url 'orders:historique' %}" class="btn-secondary flex-1 py-3 text-center text-sm">
        Voir mes commandes
      </a>
      <a href="{% url 'products:liste' %}" class="btn-primary flex-1 py-3 text-center text-sm">
        Continuer mes achats
      </a>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const COMMANDE_ID = {{ commande.id }};

const STATUTS = ['en_attente', 'confirmee', 'en_preparation', 'expediee', 'livree'];
const STATUTS_LABELS = {
  en_attente: 'En attente', confirmee: 'Confirmée',
  en_preparation: 'En préparation', expediee: 'Expédiée', livree: 'Livrée', annulee: 'Annulée'
};
const STATUTS_COLORS = {
  en_attente: 'bg-yellow-100 text-yellow-700',
  confirmee: 'bg-blue-100 text-blue-700',
  en_preparation: 'bg-purple-100 text-purple-700',
  expediee: 'bg-orange-100 text-orange-700',
  livree: 'bg-green-100 text-green-700',
  annulee: 'bg-red-100 text-red-700',
};

async function loadCommande() {
  try {
    const data = await API.get(`/api/commandes/${COMMANDE_ID}/`);
    afficherCommande(data);
  } catch(e) {}
}

function afficherCommande(c) {
  document.getElementById('skeleton').classList.add('hidden');
  document.getElementById('commande-detail').classList.remove('hidden');

  // Référence + badge statut
  document.getElementById('ref-commande').textContent = `#${c.reference || c.id}`;
  const badge = document.getElementById('statut-badge');
  badge.textContent = STATUTS_LABELS[c.statut] || c.statut;
  badge.className = `px-3 py-1 rounded-full text-xs font-body font-semibold ${STATUTS_COLORS[c.statut] || 'bg-gray-100 text-gray-600'}`;

  // Timeline
  const timeline = document.getElementById('timeline');
  const idx = STATUTS.indexOf(c.statut);
  timeline.innerHTML = STATUTS.map((s, i) => `
    <div class="flex items-center gap-1 flex-shrink-0">
      <div class="flex flex-col items-center gap-1">
        <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold
          ${i <= idx ? 'bg-brand-500 text-white' : 'bg-cream-border text-ink/30'}">
          ${i < idx ? '✓' : i + 1}
        </div>
        <span class="text-[10px] font-body ${i <= idx ? 'text-brand-600' : 'text-ink/30'}">${STATUTS_LABELS[s]}</span>
      </div>
      ${i < STATUTS.length - 1 ? `<div class="w-8 h-px mb-5 ${i < idx ? 'bg-brand-400' : 'bg-cream-border'}"></div>` : ''}
    </div>`).join('');

  // Adresse
  document.getElementById('adresse-livraison').innerHTML = `
    <p class="font-medium text-ink">${c.adresse_livraison_nom || ''}</p>
    <p>${c.adresse_livraison_telephone || ''}</p>
    <p>${c.adresse_livraison_adresse || ''}</p>
    <p>${c.adresse_livraison_ville || ''}, ${c.adresse_livraison_region || ''}</p>
    <p>${c.adresse_livraison_pays || ''}</p>`;

  // Paiement
  const p = c.paiement;
  const statutColor = p && p.statut === 'reussi' ? 'text-green-600 font-medium' : 'text-ink/40';
  document.getElementById('paiement-info').innerHTML = p
    ? `<p class="font-medium text-ink">${p.mode_affiche || p.mode}</p><p class="${statutColor}">${p.statut_affiche || p.statut}</p>`
    : `<p>Paiement à la livraison</p>`;

  // Lignes commande
  const lignes = c.lignes || [];
  document.getElementById('lignes-commande').innerHTML = lignes.map(l => `
    <div class="flex justify-between items-center text-sm font-body">
      <span class="text-ink/70">${l.produit_nom} <span class="text-ink/40">×${l.quantite}</span></span>
      <span class="text-ink font-medium">${parseInt(l.sous_total || l.prix_unitaire * l.quantite || 0).toLocaleString('fr-FR')} FCFA</span>
    </div>`).join('') || '<p class="text-ink/30 text-sm">Aucune ligne.</p>';

  // Total
  document.getElementById('total-commande').textContent = parseInt(c.montant_total || c.total || 0).toLocaleString('fr-FR') + ' FCFA';
}

loadCommande();
</script>
{% endblock %}